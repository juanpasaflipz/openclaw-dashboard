<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Green Monkey Dashboard ‚Äî Architecture</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --text-secondary: #8b949e;
    --accent: #635bff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --blue: #58a6ff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    padding: 40px 20px;
  }
  .container { max-width: 1200px; margin: 0 auto; }
  h1 {
    font-size: 32px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--accent), var(--blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  h1 + p { color: var(--text-secondary); margin-bottom: 40px; font-size: 16px; }
  h2 {
    font-size: 22px;
    margin: 48px 0 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }
  h2 span { color: var(--text-secondary); font-weight: 400; font-size: 14px; margin-left: 8px; }
  .diagram-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 32px;
    overflow-x: auto;
  }
  .diagram-card .mermaid { display: flex; justify-content: center; }
  .diagram-card .mermaid svg { max-width: 100%; height: auto; }
  .legend {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    margin: 16px 0 32px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  .legend-item { display: flex; align-items: center; gap: 6px; }
  .legend-dot {
    width: 12px; height: 12px; border-radius: 50%;
    display: inline-block; flex-shrink: 0;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 20px;
    margin-top: 16px;
  }
  .info-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
  }
  .info-card h3 {
    font-size: 15px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .info-card ul { list-style: none; font-size: 13px; color: var(--text-secondary); }
  .info-card ul li { padding: 3px 0; }
  .info-card ul li::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
  .info-card.auth ul li::before { background: var(--green); }
  .info-card.payments ul li::before { background: var(--accent); }
  .info-card.agents ul li::before { background: var(--orange); }
  .info-card.services ul li::before { background: var(--blue); }
  .info-card.llm ul li::before { background: var(--red); }
  .info-card.data ul li::before { background: #bc8cff; }
  .badge {
    display: inline-block;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }
  .badge.free { background: rgba(63, 185, 80, 0.15); color: var(--green); }
  .badge.pro { background: rgba(99, 91, 255, 0.15); color: var(--accent); }
  footer {
    margin-top: 60px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    color: var(--text-secondary);
    font-size: 13px;
    text-align: center;
  }
</style>
</head>
<body>
<div class="container">

<h1>Green Monkey Dashboard Architecture</h1>
<p>System overview ‚Äî how every component connects, who does what, and where data flows.</p>

<div class="legend">
  <div class="legend-item"><span class="legend-dot" style="background:var(--green)"></span> User / Auth</div>
  <div class="legend-item"><span class="legend-dot" style="background:var(--accent)"></span> Payments</div>
  <div class="legend-item"><span class="legend-dot" style="background:var(--orange)"></span> AI Agents</div>
  <div class="legend-item"><span class="legend-dot" style="background:var(--blue)"></span> External Services</div>
  <div class="legend-item"><span class="legend-dot" style="background:var(--red)"></span> LLM Providers</div>
  <div class="legend-item"><span class="legend-dot" style="background:#bc8cff"></span> Database</div>
</div>

<!-- ======================================== -->
<h2>1. High-Level System Architecture</h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#635bff','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#58a6ff','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d','clusterBkg':'#0d1117','clusterBorder':'#30363d','titleColor':'#e6edf3','edgeLabelBackground':'#161b22','noteTextColor':'#e6edf3','noteBkgColor':'#161b22'}}}%%
graph TB
    subgraph USER["üë§ User"]
        Browser["Browser<br/><small>dashboard.html + dashboard-main.js</small>"]
    end

    subgraph FLASK["üñ•Ô∏è Flask Backend (server.py)"]
        Auth["auth_routes<br/><small>Magic Link Login</small>"]
        Chat["chatbot_routes<br/><small>Conversation + Tool Loop</small>"]
        Agents["agent_routes<br/><small>Agent CRUD</small>"]
        Actions["agent_actions_routes<br/><small>Approval Queue</small>"]
        OAuth["oauth_routes<br/><small>Service Connection</small>"]
        Stripe["stripe_routes<br/><small>Payments + Webhooks</small>"]
        Models["model_config_routes<br/><small>LLM Setup</small>"]
        ServiceRoutes["Service Routes<br/><small>gmail, calendar, drive,<br/>github, slack, spotify, etc.</small>"]
    end

    subgraph CORE["‚öôÔ∏è Core Services"]
        LLM["llm_service.py<br/><small>Unified LLM Abstraction</small>"]
        Tools["agent_tools.py<br/><small>25 Tool Registry</small>"]
        Limiter["rate_limiter.py"]
    end

    subgraph DB["üóÑÔ∏è Database"]
        PG["Neon PostgreSQL<br/><small>Production</small>"]
        SQLite["SQLite<br/><small>Local Dev</small>"]
    end

    subgraph EXTERNAL["üåê External Services"]
        SendGrid["SendGrid<br/><small>Email</small>"]
        StripeAPI["Stripe API<br/><small>Payments</small>"]
        GApis["Google APIs<br/><small>Gmail ¬∑ Calendar ¬∑ Drive</small>"]
        SvcAPIs["Service APIs<br/><small>GitHub ¬∑ Slack ¬∑ Spotify<br/>Discord ¬∑ Todoist ¬∑ Dropbox<br/>Telegram ¬∑ Notion ¬∑ Binance</small>"]
    end

    subgraph LLMs["ü§ñ LLM Providers"]
        OpenAI["OpenAI"]
        Anthropic["Anthropic"]
        Google["Google Gemini"]
        Groq["Groq"]
        Mistral["Mistral"]
        Together["Together"]
        xAI["xAI Grok"]
        OpenRouter["OpenRouter"]
        Cohere["Cohere"]
        Ollama["Ollama<br/><small>Local</small>"]
    end

    Browser -->|"fetch() + session cookie"| Auth
    Browser -->|"POST /api/chat/send"| Chat
    Browser -->|"CRUD"| Agents
    Browser -->|"approve / reject"| Actions
    Browser -->|"OAuth popup"| OAuth
    Browser -->|"checkout"| Stripe

    Chat --> LLM
    Chat --> Tools
    Tools --> ServiceRoutes
    Actions --> ServiceRoutes
    ServiceRoutes --> GApis
    ServiceRoutes --> SvcAPIs
    Auth --> SendGrid
    Stripe --> StripeAPI
    LLM --> OpenAI & Anthropic & Google & Groq & Mistral & Together & xAI & OpenRouter & Cohere & Ollama
    OAuth --> GApis
    OAuth --> SvcAPIs

    Auth --> PG
    Chat --> PG
    Agents --> PG
    Actions --> PG
    Stripe --> PG
</pre>
</div>

<!-- ======================================== -->
<h2>2. Authentication Flow <span>Magic Link Email Auth</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#3fb950','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#3fb950','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d'}}}%%
sequenceDiagram
    participant U as üë§ User
    participant F as üñ•Ô∏è Flask
    participant DB as üóÑÔ∏è Database
    participant SG as ‚úâÔ∏è SendGrid

    U->>F: POST /api/auth/request-magic-link {email}
    F->>DB: Find or create User
    F->>DB: Create MagicLink (token, 15-min expiry)
    F->>SG: Send email with link
    SG-->>U: Email with magic link

    U->>F: GET /api/auth/verify?token=xyz
    F->>DB: Find MagicLink by token
    F->>F: Validate: not expired, not used
    F->>DB: Mark MagicLink as used
    F->>DB: Update User.last_login
    F-->>U: Set session cookie + redirect

    Note over U,F: All subsequent requests include session cookie

    U->>F: GET /api/auth/me
    F->>DB: Lookup session user_id
    F-->>U: {user, credits, subscription, is_admin}

    U->>F: POST /api/auth/logout
    F->>F: Clear session
    F-->>U: {success: true}
</pre>
</div>

<!-- ======================================== -->
<h2>3. Payment & Subscription Flow <span>Stripe Integration</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#635bff','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#635bff','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d'}}}%%
sequenceDiagram
    participant U as üë§ User
    participant F as üñ•Ô∏è Flask
    participant S as üí≥ Stripe
    participant DB as üóÑÔ∏è Database

    rect rgb(30, 25, 60)
    Note over U,DB: Credit Purchase (One-Time)
    U->>F: POST /api/credits/create-checkout {package_id}
    F->>S: Create Checkout Session (mode: payment)
    S-->>F: {checkout_url}
    F-->>U: Redirect to Stripe
    U->>S: Complete payment
    S->>F: Webhook: checkout.session.completed
    F->>DB: User.credit_balance += credits
    F->>DB: Create CreditTransaction
    end

    rect rgb(25, 35, 25)
    Note over U,DB: Subscription (Recurring)
    U->>F: POST /api/subscriptions/create-checkout {plan_id}
    F->>S: Create Checkout Session (mode: subscription)
    S-->>U: Checkout page
    U->>S: Subscribe
    S->>F: Webhook: customer.subscription.created
    F->>DB: User ‚Üí tier: pro, status: active
    S->>F: Webhook: invoice.payment_succeeded (monthly)
    F->>DB: Extend subscription_expires_at
    S->>F: Webhook: invoice.payment_failed
    F->>DB: User.subscription_status ‚Üí past_due
    S->>F: Webhook: customer.subscription.deleted
    F->>DB: User ‚Üí tier: free, status: cancelled
    end
</pre>
</div>

<!-- ======================================== -->
<h2>4. Agent Tool-Calling Flow <span>LLM ‚Üî Service API Loop</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#d29922','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#d29922','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d'}}}%%
sequenceDiagram
    participant U as üë§ User
    participant F as üñ•Ô∏è chatbot_routes
    participant T as üîß agent_tools
    participant L as ü§ñ LLM Provider
    participant API as üåê Service API
    participant DB as üóÑÔ∏è Database

    U->>F: POST /api/chat/send {message}
    F->>DB: Save user ChatMessage
    F->>T: get_tools_for_user(user_id)
    T->>DB: Query connected Superpowers
    T-->>F: [tool schemas for connected services]
    F->>T: get_tools_system_prompt(user_id)
    T-->>F: System prompt with available tools

    loop Max 5 iterations
        F->>L: LLMService.call(messages, tools)
        alt LLM returns text only
            L-->>F: {content: "Here are your repos..."}
            F->>DB: Save assistant ChatMessage
            F-->>U: {messages: [...]}
        else LLM returns tool_calls
            L-->>F: {tool_calls: [{name: "get_github_repos"}]}
            F->>DB: Save assistant msg + tool_calls metadata
            F->>T: execute_tool("get_github_repos", user_id, args)
            T->>DB: Get Superpower access_token
            T->>API: GET https://api.github.com/user/repos
            API-->>T: [{repo1}, {repo2}, ...]
            T-->>F: {repos: [...]}
            F->>DB: Save tool result ChatMessage
            Note over F,L: Loop continues ‚Äî feed results back to LLM
        end
    end
</pre>
</div>

<!-- ======================================== -->
<h2>5. OAuth Service Connection <span>Superpower Registration</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#58a6ff','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#58a6ff','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d'}}}%%
sequenceDiagram
    participant U as üë§ User
    participant F as üñ•Ô∏è Flask
    participant P as üîê OAuth Provider
    participant DB as üóÑÔ∏è Database

    U->>F: GET /api/oauth/{provider}/start
    F->>F: Build auth URL + state token
    F-->>U: {authorization_url}
    U->>P: Authorize in popup window
    P-->>F: GET /api/oauth/{provider}/callback?code=xyz

    F->>P: Exchange code for tokens
    P-->>F: {access_token, refresh_token}

    F->>DB: Find or create Superpower
    F->>DB: Store tokens (encrypted)
    F->>DB: Set is_enabled = true
    F-->>U: Close popup + refresh dashboard

    Note over U,DB: Later ‚Äî token refresh on API call
    U->>F: Use connected service
    F->>DB: Get Superpower tokens
    F->>P: API call with access_token
    alt Token expired
        F->>P: POST /token (refresh_token)
        P-->>F: New access_token
        F->>DB: Update Superpower tokens
        F->>P: Retry API call
    end
    P-->>F: API response
    F-->>U: Service data
</pre>
</div>

<!-- ======================================== -->
<h2>6. LLM Provider Abstraction <span>llm_service.py</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#f85149','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#f85149','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d','clusterBkg':'#0d1117','clusterBorder':'#30363d'}}}%%
graph LR
    subgraph Entry["LLMService.call()"]
        Call["call(provider, model,<br/>api_key, messages, tools)"]
    end

    subgraph Routing["Provider Routing"]
        OAI["_call_openai_compatible()"]
        ANT["_call_anthropic()"]
        GOO["_call_google()"]
        OLL["_call_ollama()"]
        COH["_call_cohere()"]
    end

    subgraph Providers["Providers"]
        P1["OpenAI"]
        P2["Groq"]
        P3["Mistral"]
        P4["Together"]
        P5["xAI Grok"]
        P6["OpenRouter"]
        P7["Azure"]
        P8["Custom"]
        P9["Anthropic"]
        P10["Google Gemini"]
        P11["Ollama"]
        P12["Cohere"]
    end

    subgraph ToolSupport["Tool Calling Support"]
        TC["‚úÖ Supports tools"]
        NT["‚ùå No tool support"]
    end

    Call --> OAI & ANT & GOO & OLL & COH

    OAI --> P1 & P2 & P3 & P4 & P5 & P6 & P7 & P8
    ANT --> P9
    GOO --> P10
    OLL --> P11
    COH --> P12

    P1 & P2 & P3 & P4 & P5 & P6 & P7 & P9 --> TC
    P8 & P10 & P11 & P12 --> NT
</pre>
</div>

<!-- ======================================== -->
<h2>7. Database Models & Relationships <span>models.py</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#bc8cff','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#bc8cff','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d','clusterBkg':'#0d1117','clusterBorder':'#30363d'}}}%%
erDiagram
    User ||--o{ Agent : "has many"
    User ||--o{ Superpower : "connects"
    User ||--o{ CreditTransaction : "purchases"
    User ||--o{ MagicLink : "authenticates"
    User ||--o{ UserModelConfig : "configures"
    User ||--o{ ChatConversation : "chats in"
    User ||--o{ ExternalAgent : "manages"
    User ||--o{ PostHistory : "posts"

    Agent ||--o{ AgentAction : "proposes"
    Agent ||--o{ AnalyticsSnapshot : "tracks"

    ChatConversation ||--o{ ChatMessage : "contains"

    CreditPackage ||--o{ CreditTransaction : "sold via"
    SubscriptionPlan }o--|| User : "subscribes to"

    User {
        int id PK
        string email UK
        int credit_balance
        string subscription_tier
        string subscription_status
        string stripe_customer_id
        boolean is_admin
    }

    Agent {
        int id PK
        int user_id FK
        string name
        string personality
        json llm_config
    }

    Superpower {
        int id PK
        int user_id FK
        string service_type
        string access_token_encrypted
        string refresh_token_encrypted
        boolean is_enabled
    }

    AgentAction {
        int id PK
        int agent_id FK
        string action_type
        string service_type
        string status
        json action_data
        string ai_reasoning
    }

    ChatConversation {
        string conversation_id PK
        int user_id FK
        string title
        string feature
        string agent_type
    }

    ChatMessage {
        int id PK
        string conversation_id FK
        string role
        text content
        json metadata_json
    }

    UserModelConfig {
        int id PK
        int user_id FK
        string feature_slot
        string provider
        string model
        string api_key
    }
</pre>
</div>

<!-- ======================================== -->
<h2>8. Agent Tool Registry <span>25 tools across 13 services</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#d29922','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#d29922','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d','clusterBkg':'#0d1117','clusterBorder':'#30363d'}}}%%
graph TB
    subgraph META["Meta Tools ‚Äî Always Available"]
        M1["list_connected_services"]
        M2["connect_service"]
    end

    subgraph GH["GitHub"]
        G1["get_github_repos"]
        G2["get_github_issues"]
    end

    subgraph SL["Slack"]
        S1["get_slack_channels"]
        S2["get_slack_messages"]
    end

    subgraph SP["Spotify"]
        SP1["get_spotify_profile"]
        SP2["get_spotify_playlists"]
        SP3["get_spotify_now_playing"]
    end

    subgraph TG["Telegram"]
        T1["get_telegram_bot_info"]
        T2["get_telegram_updates"]
    end

    subgraph TD["Todoist"]
        TD1["get_todoist_projects"]
        TD2["get_todoist_tasks"]
    end

    subgraph DC["Discord"]
        DC1["get_discord_guilds"]
        DC2["get_discord_channels"]
    end

    subgraph DB["Dropbox"]
        DB1["get_dropbox_files"]
        DB2["get_dropbox_metadata"]
    end

    subgraph GM["Gmail"]
        GM1["get_gmail_recent"]
        GM2["get_gmail_email"]
    end

    subgraph CAL["Calendar"]
        C1["get_calendar_events"]
    end

    subgraph DR["Drive"]
        DR1["get_drive_files"]
        DR2["search_drive"]
    end

    subgraph NT["Notion"]
        N1["search_notion"]
    end

    subgraph BN["Binance"]
        B1["get_binance_portfolio"]
        B2["get_binance_prices"]
    end

    LLM["ü§ñ LLM Agent"]
    LLM --> META
    LLM --> GH & SL & SP & TG & TD & DC & DB & GM & CAL & DR & NT & BN
</pre>
</div>

<!-- ======================================== -->
<h2>9. Component Responsibilities</h2>

<div class="grid">
  <div class="info-card auth">
    <h3>üîê Authentication</h3>
    <ul>
      <li>Magic link email (15-min expiry, one-time use)</li>
      <li>SendGrid for email delivery</li>
      <li>Server-side sessions (cookie-based)</li>
      <li>OWNER_EMAIL auto-promotes to admin</li>
      <li>Rate limited: 5/min, 20/hour</li>
    </ul>
  </div>

  <div class="info-card payments">
    <h3>üí≥ Payments (Stripe)</h3>
    <ul>
      <li><span class="badge free">Free</span> 1 agent, 5 starter credits</li>
      <li><span class="badge pro">Pro $15/mo</span> 999 agents, analytics</li>
      <li>Credit packs: one-time purchase</li>
      <li>Webhook-driven state updates</li>
      <li>Billing portal for self-service</li>
    </ul>
  </div>

  <div class="info-card agents">
    <h3>ü§ñ Agent System</h3>
    <ul>
      <li>Per-user agents with personality config</li>
      <li>Approval queue for proposed actions</li>
      <li>Clone, export, import agents</li>
      <li>External agent support (Nautilus, HTTP)</li>
      <li>Multi-channel deployment</li>
    </ul>
  </div>

  <div class="info-card services">
    <h3>üîó Connected Services (Superpowers)</h3>
    <ul>
      <li>OAuth 2.0: Google, Slack, GitHub, Discord, Spotify, Todoist, Dropbox</li>
      <li>Token-based: Telegram, Notion</li>
      <li>API keys: Binance</li>
      <li>Auto-refresh expired tokens</li>
      <li>Per-user encrypted storage</li>
    </ul>
  </div>

  <div class="info-card llm">
    <h3>üß† LLM Providers</h3>
    <ul>
      <li>12 providers: OpenAI, Anthropic, Google, Groq, Mistral, Together, xAI, OpenRouter, Cohere, Azure, Ollama, Custom</li>
      <li>Per-feature model config (chatbot, web, utility)</li>
      <li>Tool-calling on 8 providers</li>
      <li>Unified abstraction in llm_service.py</li>
      <li>Connection test before saving</li>
    </ul>
  </div>

  <div class="info-card data">
    <h3>üóÑÔ∏è Data & Infrastructure</h3>
    <ul>
      <li>Neon PostgreSQL (production, SSL)</li>
      <li>SQLite (local development)</li>
      <li>Flask-SQLAlchemy ORM</li>
      <li>Vercel deployment (@vercel/python)</li>
      <li>Connection pooling (5 + 10 overflow)</li>
    </ul>
  </div>
</div>

<!-- ======================================== -->
<h2>10. Request Lifecycle <span>End-to-End</span></h2>

<div class="diagram-card">
<pre class="mermaid">
%%{init: {'theme':'dark','themeVariables':{'primaryColor':'#635bff','primaryTextColor':'#e6edf3','primaryBorderColor':'#30363d','lineColor':'#8b949e','secondaryColor':'#161b22','tertiaryColor':'#0d1117','background':'#161b22','mainBkg':'#161b22','nodeBorder':'#30363d','clusterBkg':'#0d1117','clusterBorder':'#30363d'}}}%%
graph TD
    A["üë§ Browser Request"] --> B{"Has session cookie?"}
    B -->|No| C["401 Unauthorized"]
    B -->|Yes| D["Flask Route Handler"]
    D --> E{"Rate Limit OK?"}
    E -->|No| F["429 Too Many Requests"]
    E -->|Yes| G{"Subscription Check?"}
    G -->|Feature needs Pro| H{"User is Pro?"}
    H -->|No| I["403 Upgrade Required"]
    H -->|Yes| J["Execute Logic"]
    G -->|Free feature| J
    J --> K{"Needs LLM?"}
    K -->|Yes| L["Load UserModelConfig"]
    L --> M["LLMService.call()"]
    M --> N{"Tool calls?"}
    N -->|Yes| O["agent_tools.execute_tool()"]
    O --> P["External API Call"]
    P --> M
    N -->|No| Q["Return Response"]
    K -->|No| R["DB Query / API Call"]
    R --> Q
    Q --> S["200 JSON Response"]
</pre>
</div>

<footer>
  Green Monkey Dashboard &mdash; Architecture generated February 2026
</footer>

</div>

<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark',
    securityLevel: 'loose',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
  });
</script>
</body>
</html>
