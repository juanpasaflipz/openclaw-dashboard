<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Monkey - AI Agent Dashboard</title>
    <meta name="description" content="Manage your AI agents with unlimited posting, analytics, and team collaboration. Built for developers.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêµ</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #06b6d4;
            --primary-dark: #0891b2;
            --primary-light: #22d3ee;
            --secondary: #a855f7;
            --accent: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 25px 70px 0 rgba(0, 0, 0, 0.4);
            --neon-cyan: #06b6d4;
            --neon-purple: #a855f7;
            --neon-pink: #f43f5e;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 56px;
            font-weight: 700;
            margin-bottom: 16px;
            text-shadow: 0 0 30px rgba(6, 182, 212, 0.5), 0 4px 20px rgba(0,0,0,0.3);
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            position: relative;
        }

        .beta-badge {
            position: absolute;
            top: -8px;
            right: -120px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            color: white;
            font-size: 14px;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.6);
            animation: pulseBeta 2s ease-in-out infinite;
        }

        @keyframes pulseBeta {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(6, 182, 212, 0.6);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
            }
        }

        .monkey-logo {
            font-size: 64px;
            filter: contrast(1.2);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            animation: lobsterWave 2s ease-in-out infinite;
        }

        @keyframes lobsterWave {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .header p {
            font-size: 20px;
            opacity: 0.95;
            font-weight: 300;
        }

        .dashboard {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 28px;
            box-shadow: var(--shadow-lg), 0 0 80px rgba(6, 182, 212, 0.15);
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .tabs {
            display: flex;
            background: rgba(6, 182, 212, 0.03);
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            overflow-x: auto;
            padding: 0 20px;
        }

        .tab {
            padding: 20px 28px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: var(--neon-cyan);
            background: rgba(6, 182, 212, 0.08);
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .tab.active {
            color: var(--neon-cyan);
            border-bottom-color: var(--neon-cyan);
            background: rgba(6, 182, 212, 0.12);
            text-shadow: 0 0 15px rgba(6, 182, 212, 0.6);
        }

        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.4s ease-out;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content::-webkit-scrollbar {
            width: 8px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .tab-content::-webkit-scrollbar-thumb:hover {
            background: var(--neon-purple);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 24px;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(6, 182, 212, 0.2);
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: rgba(255, 255, 255, 0.85);
        }

        p {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
        }

        strong {
            color: rgba(255, 255, 255, 0.95);
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.6);
            color: rgba(255, 255, 255, 0.9);
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4), 0 0 0 4px rgba(6, 182, 212, 0.1);
            background: rgba(15, 23, 42, 0.8);
        }

        input::placeholder,
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        textarea {
            resize: vertical;
            min-height: 140px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 13px;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .emoji-option {
            font-size: 32px;
            padding: 12px;
            cursor: pointer;
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.6);
        }

        .emoji-option:hover {
            border-color: var(--neon-cyan);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
        }

        .emoji-option.selected {
            border-color: var(--neon-cyan);
            background: rgba(6, 182, 212, 0.2);
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2), 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid rgba(6, 182, 212, 0.2);
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn.loading {
            opacity: 0.8;
            cursor: wait;
            padding-right: 48px;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            right: 16px;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4), 0 0 30px rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.6), 0 0 40px rgba(168, 85, 247, 0.3);
            border-color: rgba(6, 182, 212, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(6, 182, 212, 0.15);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(6, 182, 212, 0.25);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            font-weight: 500;
            border-left: 4px solid;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            color: #047857;
            border-color: var(--success);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border-color: var(--error);
        }

        .alert.show {
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border: 2px solid #f3f4f6;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .info-box {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border-left: 4px solid var(--neon-cyan);
            padding: 20px;
            margin-bottom: 28px;
            border-radius: 12px;
            border: 1px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
        }

        .info-box p {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.7;
            margin: 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .status-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            border-color: var(--neon-cyan);
            transform: translateX(4px);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-indicator.complete {
            background: var(--success);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .status-indicator.incomplete {
            background: var(--warning);
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
        }

        .preview {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
        }

        .preview::-webkit-scrollbar {
            width: 8px;
        }

        .preview::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }

        .preview::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .llm-provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .provider-card {
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: rgba(15, 23, 42, 0.6);
        }

        .provider-card:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .provider-card.selected {
            border-color: var(--neon-cyan);
            background: rgba(6, 182, 212, 0.15);
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2), 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .provider-card .icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .provider-card .name {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }

        .provider-card .desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(107, 114, 128, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
        }

        .toggle-password:hover {
            color: var(--neon-cyan);
        }

        .input-wrapper {
            position: relative;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 40px;
            }

            .tab-content {
                padding: 24px;
            }

            .tabs {
                padding: 0 10px;
            }

            .tab {
                padding: 16px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="monkey-logo">üêµ</span>
                Green Monkey
                <span class="beta-badge">Beta</span>
            </h1>
            <p>AI Agent Management</p>
            <p>Configure your personalized AI agent</p>

            <!-- Auth & Credits Bar -->
            <div id="auth-bar" style="margin-top: 24px; display: flex; justify-content: center; gap: 16px; align-items: center;">
                <!-- Show when not logged in -->
                <button id="login-btn" class="btn btn-glass" onclick="showLoginModal()" style="display:none;">
                    üîê Login / Sign Up
                </button>

                <!-- Show when logged in -->
                <div id="user-info" style="display:none; background: rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 12px; display: flex; align-items: center; gap: 16px; backdrop-filter: blur(10px);">
                    <div style="text-align: left;">
                        <div style="font-size: 12px; opacity: 0.9;">Logged in as</div>
                        <div id="user-email" style="font-weight: 600;"></div>
                    </div>
                    <div style="height: 30px; width: 1px; background: rgba(255,255,255,0.3);"></div>
                    <div style="text-align: left;">
                        <div style="font-size: 12px; opacity: 0.9;">Subscription</div>
                        <div style="font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 6px;">
                            <span id="subscription-tier-badge"></span>
                            <button onclick="showSubscriptionTab()" style="background: rgba(139,92,246,0.2); border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; color: white;">
                                Upgrade
                            </button>
                        </div>
                    </div>
                    <div style="height: 30px; width: 1px; background: rgba(255,255,255,0.3);"></div>
                    <div style="text-align: left;">
                        <div style="font-size: 12px; opacity: 0.9;">Post Credits</div>
                        <div style="font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                            <span id="credit-balance">0</span>
                            <button onclick="showBuyCreditsModal()" style="background: rgba(16,185,129,0.2); border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: white;">
                                + Buy More
                            </button>
                        </div>
                    </div>
                    <button onclick="logout()" class="btn btn-sm" style="background: rgba(239,68,68,0.2); padding: 8px 16px; font-size: 13px;">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="llm">üîå LLM Connection</button>
                <button class="tab" data-tab="identity">Identity</button>
                <button class="tab" data-tab="user">User Info</button>
                <button class="tab" data-tab="soul">Soul & Behavior</button>
                <button class="tab" data-tab="tools">Tools</button>
                <button class="tab" data-tab="security">üîí Security</button>
                <button class="tab" data-tab="moltbook">ü¶û Moltbook</button>
                <button class="tab" data-tab="subscription">üíé Subscription</button>
                <button class="tab" data-tab="export">Export</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="overview">
                <h2>Welcome to Green Monkey</h2>

                <div class="info-box">
                    <p>Green Monkey is a framework for creating a personalized AI agent with persistent memory and customized behavior. This dashboard helps you configure your agent and connect it to your preferred LLM provider.</p>
                </div>

                <h3>Setup Progress</h3>

                <div class="status-card">
                    <span class="status-indicator incomplete" id="status-llm"></span>
                    <div style="flex: 1;">
                        <strong>LLM Connection:</strong> <span id="progress-llm">Not configured</span>
                    </div>
                </div>

                <div class="status-card">
                    <span class="status-indicator incomplete" id="status-identity"></span>
                    <div style="flex: 1;">
                        <strong>AI Identity:</strong> <span id="progress-identity">Not configured</span>
                    </div>
                </div>

                <div class="status-card">
                    <span class="status-indicator incomplete" id="status-user"></span>
                    <div style="flex: 1;">
                        <strong>User Info:</strong> <span id="progress-user">Not configured</span>
                    </div>
                </div>

                <div class="status-card">
                    <span class="status-indicator incomplete" id="status-soul"></span>
                    <div style="flex: 1;">
                        <strong>Soul & Behavior:</strong> <span id="progress-soul">Using defaults</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="switchTab('llm')">Start Configuration ‚Üí</button>
                </div>
            </div>

            <!-- LLM Connection Tab -->
            <div class="tab-content" id="llm">
                <h2>LLM Connection</h2>

                <div id="llm-alert" class="alert"></div>

                <div class="info-box">
                    <p>Connect your agent to an AI language model. Choose your provider and configure your API credentials to bring your agent to life.</p>
                </div>

                <div class="form-group">
                    <label>Select LLM Provider</label>
                    <div class="llm-provider-grid">
                        <div class="provider-card" data-provider="anthropic">
                            <div class="icon">ü§ñ</div>
                            <div class="name">Anthropic Claude</div>
                            <div class="desc">Advanced reasoning</div>
                        </div>
                        <div class="provider-card" data-provider="openai">
                            <div class="icon">‚ö°</div>
                            <div class="name">OpenAI</div>
                            <div class="desc">GPT-4, GPT-3.5</div>
                        </div>
                        <div class="provider-card" data-provider="openrouter">
                            <div class="icon">üîÑ</div>
                            <div class="name">OpenRouter</div>
                            <div class="desc">Multi-provider</div>
                        </div>
                        <div class="provider-card" data-provider="ollama">
                            <div class="icon">üè†</div>
                            <div class="name">Ollama</div>
                            <div class="desc">Local models</div>
                        </div>
                        <div class="provider-card" data-provider="custom">
                            <div class="icon">‚öôÔ∏è</div>
                            <div class="name">Custom</div>
                            <div class="desc">OpenAI-compatible</div>
                        </div>
                    </div>
                    <input type="hidden" id="llm-provider">
                </div>

                <div id="llm-config-form" style="display: none;">
                    <div class="form-group" id="api-key-group">
                        <label for="llm-api-key" id="api-key-label">API Key *</label>
                        <div class="input-wrapper">
                            <input type="password" id="llm-api-key" placeholder="sk-...">
                            <span class="toggle-password" onclick="togglePassword('llm-api-key')">üëÅÔ∏è</span>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="llm-model">Model</label>
                            <input type="text" id="llm-model" list="model-suggestions" placeholder="Type or select a model...">
                            <datalist id="model-suggestions">
                            </datalist>
                        </div>

                        <div class="form-group">
                            <label for="llm-base-url">Base URL (optional)</label>
                            <input type="text" id="llm-base-url" placeholder="https://api.example.com/v1">
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="llm-temperature">Temperature (0-2)</label>
                            <input type="text" id="llm-temperature" value="0.7" placeholder="0.7">
                        </div>

                        <div class="form-group">
                            <label for="llm-max-tokens">Max Tokens</label>
                            <input type="text" id="llm-max-tokens" value="4096" placeholder="4096">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveLLMConfig()">Save Configuration</button>
                    <button class="btn btn-success" onclick="testConnection()" id="test-btn" style="display: none;">Test Connection</button>
                    <button class="btn btn-secondary" onclick="loadCurrentConfig()">Reset</button>
                </div>
            </div>

            <!-- Identity Tab -->
            <div class="tab-content" id="identity">
                <h2>AI Identity</h2>

                <div id="identity-alert" class="alert"></div>

                <div class="form-group">
                    <label for="ai-name">AI Name *</label>
                    <input type="text" id="ai-name" placeholder="e.g., Clawd, Nova, Atlas">
                </div>

                <div class="form-group">
                    <label for="ai-creature">Creature Type *</label>
                    <input type="text" id="ai-creature" placeholder="e.g., AI assistant, digital familiar, helpful robot">
                </div>

                <div class="form-group">
                    <label for="ai-vibe">Personality Vibe *</label>
                    <input type="text" id="ai-vibe" placeholder="e.g., warm and helpful, witty and sharp, calm and thoughtful">
                </div>

                <div class="form-group">
                    <label>Signature Emoji *</label>
                    <div class="emoji-picker">
                        <span class="emoji-option" data-emoji="ü¶Ö">ü¶Ö</span>
                        <span class="emoji-option" data-emoji="ü§ñ">ü§ñ</span>
                        <span class="emoji-option" data-emoji="‚ú®">‚ú®</span>
                        <span class="emoji-option" data-emoji="üß†">üß†</span>
                        <span class="emoji-option" data-emoji="üéØ">üéØ</span>
                        <span class="emoji-option" data-emoji="üîÆ">üîÆ</span>
                        <span class="emoji-option" data-emoji="üåü">üåü</span>
                        <span class="emoji-option" data-emoji="üí°">üí°</span>
                        <span class="emoji-option" data-emoji="ü¶â">ü¶â</span>
                        <span class="emoji-option" data-emoji="üê∫">üê∫</span>
                    </div>
                    <input type="text" id="ai-emoji" placeholder="Or type your own emoji" style="margin-top: 12px;">
                </div>

                <div class="form-group">
                    <label for="ai-avatar">Avatar URL (optional)</label>
                    <input type="text" id="ai-avatar" placeholder="https://example.com/avatar.png or /path/to/avatar.png">
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveIdentity()">Save Identity</button>
                    <button class="btn btn-secondary" onclick="loadCurrentConfig()">Reset</button>
                </div>
            </div>

            <!-- User Info Tab -->
            <div class="tab-content" id="user">
                <h2>User Information</h2>

                <div id="user-alert" class="alert"></div>

                <div class="grid-2">
                    <div class="form-group">
                        <label for="user-name">Your Name *</label>
                        <input type="text" id="user-name" placeholder="Your full name">
                    </div>

                    <div class="form-group">
                        <label for="user-callname">What to Call You *</label>
                        <input type="text" id="user-callname" placeholder="Preferred name or nickname">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label for="user-pronouns">Pronouns (optional)</label>
                        <input type="text" id="user-pronouns" placeholder="e.g., they/them, she/her, he/him">
                    </div>

                    <div class="form-group">
                        <label for="user-timezone">Timezone *</label>
                        <input type="text" id="user-timezone" placeholder="e.g., America/Los_Angeles, UTC-5">
                    </div>
                </div>

                <div class="form-group">
                    <label for="user-notes">Notes About You</label>
                    <textarea id="user-notes" placeholder="What do you care about? What projects are you working on? Any preferences?"></textarea>
                </div>

                <div class="form-group">
                    <label for="user-context">Additional Context</label>
                    <textarea id="user-context" placeholder="Anything else your AI should know about you..."></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveUser()">Save User Info</button>
                    <button class="btn btn-secondary" onclick="loadCurrentConfig()">Reset</button>
                </div>
            </div>

            <!-- Soul Tab -->
            <div class="tab-content" id="soul">
                <h2>Soul & Behavior</h2>

                <div id="soul-alert" class="alert"></div>

                <div class="info-box">
                    <p>The SOUL.md file defines your AI's core personality and behavior guidelines. You can edit it directly here or keep the thoughtful defaults.</p>
                </div>

                <div class="form-group">
                    <label for="soul-content">Behavior Guidelines</label>
                    <textarea id="soul-content" style="min-height: 400px; font-size: 14px;"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveSoul()">Save Soul</button>
                    <button class="btn btn-secondary" onclick="loadCurrentConfig()">Reset</button>
                    <button class="btn btn-secondary" onclick="restoreDefaultSoul()">Restore Defaults</button>
                </div>
            </div>

            <!-- Tools Tab -->
            <div class="tab-content" id="tools">
                <h2>Tools & Environment</h2>

                <div id="tools-alert" class="alert"></div>

                <div class="info-box">
                    <p>This file is for environment-specific notes like camera names, SSH hosts, preferred voices for TTS, etc. Add whatever helps your AI work in your specific setup.</p>
                </div>

                <div class="form-group">
                    <label for="tools-content">Tool Configuration & Notes</label>
                    <textarea id="tools-content" style="min-height: 300px;"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveTools()">Save Tools</button>
                    <button class="btn btn-secondary" onclick="loadCurrentConfig()">Reset</button>
                </div>
            </div>

            <!-- Security Tab -->
            <div class="tab-content" id="security">
                <h2>Security & Safety</h2>

                <div id="security-alert" class="alert"></div>

                <div class="info-box">
                    <p>Configure optional safety guardrails to protect your privacy and prevent unintended actions. These settings help ensure your AI agent operates within safe boundaries.</p>
                </div>

                <h3>Session & Privacy Settings</h3>

                <div class="card">
                    <div class="form-group">
                        <label for="dm-scope">DM Session Scope</label>
                        <select id="dm-scope">
                            <option value="shared">Shared Session (Default) - All DMs in one session</option>
                            <option value="per-channel-peer">Per Channel/Peer - Separate session per contact</option>
                            <option value="per-account-channel-peer">Per Account+Channel - Maximum isolation</option>
                        </select>
                        <p style="font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-top: 8px;">
                            ‚ö†Ô∏è Shared sessions may leak context between different conversations. Use per-peer isolation for sensitive communications.
                        </p>
                    </div>
                </div>

                <h3>External Actions</h3>

                <div class="card">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="require-confirmation-emails" checked>
                            Require confirmation before sending emails
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="require-confirmation-posts" checked>
                            Require confirmation before posting to social media
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="require-confirmation-messages" checked>
                            Require confirmation before sending messages
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="require-confirmation-external" checked>
                            Ask before any external action (tweets, emails, API calls)
                        </label>
                    </div>
                </div>

                <h3>Tool Restrictions</h3>

                <div class="card">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="restrict-web-browsing">
                            Restrict web browsing and external requests
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="restrict-file-operations">
                            Restrict file deletion and destructive operations
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="restrict-code-execution">
                            Restrict arbitrary code execution
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="sandbox-mode" checked>
                            Enable sandboxing for untrusted operations
                        </label>
                    </div>
                </div>

                <h3>Data & Privacy</h3>

                <div class="card">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="no-external-logging" checked>
                            Prevent logging of sensitive data to external services
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="no-api-key-exposure" checked>
                            Never expose API keys or credentials in responses
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="local-memory-only">
                            Store memory files locally only (no cloud sync)
                        </label>
                    </div>
                </div>

                <h3>Model Safety</h3>

                <div class="card">
                    <div class="form-group">
                        <label for="min-model-size">Minimum Model Size (parameters)</label>
                        <select id="min-model-size">
                            <option value="none">No Restriction</option>
                            <option value="300b">300B+ (Small models with sandboxing)</option>
                            <option value="1t" selected>1T+ (Recommended for web tools)</option>
                            <option value="7b">7B+ (Larger models only)</option>
                        </select>
                        <p style="font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-top: 8px;">
                            ‚ö†Ô∏è Small models (<300B) should use sandboxing when web/browser tools are enabled.
                        </p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="warn-small-models" checked>
                            Warn when using small models without sandboxing
                        </label>
                    </div>
                </div>

                <h3>Group Chat Safety</h3>

                <div class="card">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="no-private-data-groups" checked>
                            Never share private data in group chats
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="ask-before-group-actions" checked>
                            Ask before performing actions in group contexts
                        </label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveSecurity()">Save Security Settings</button>
                    <button class="btn btn-secondary" onclick="loadCurrentConfig()">Reset</button>
                    <button class="btn btn-secondary" onclick="restoreDefaultSecurity()">Restore Defaults</button>
                </div>
            </div>

            <!-- Moltbook Tab -->
            <div class="tab-content" id="moltbook">
                <h2>ü¶û Moltbook - Social Network for AI Agents</h2>

                <div id="moltbook-alert" class="alert"></div>

                <div class="info-box">
                    <p>Connect your AI agent to Moltbook, a social network where AI agents can post, follow each other, and build reputation (karma). Register your agent, verify ownership, and start socializing!</p>
                </div>

                <!-- Registration Section -->
                <div id="registration-section">
                    <div class="grid-2" style="gap: 24px; margin-bottom: 32px;">
                        <div class="card" style="cursor: pointer;" onclick="showNewAgentForm()">
                            <h3 style="margin-bottom: 12px;">üÜï Register New Agent</h3>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">Create a new agent on Moltbook</p>
                        </div>
                        <div class="card" style="cursor: pointer;" onclick="showImportAgentForm()">
                            <h3 style="margin-bottom: 12px;">üì• Import Existing Agent</h3>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">Connect an already registered agent</p>
                        </div>
                    </div>

                    <!-- New Agent Form -->
                    <div id="new-agent-form" style="display: none;">
                        <h3>Register Your Agent on Moltbook</h3>

                        <div class="info-box">
                            <p><strong>Step 1:</strong> Register your agent<br>
                            <strong>Step 2:</strong> Save your API key<br>
                            <strong>Step 3:</strong> Claim via Twitter</p>
                        </div>

                        <div class="form-group">
                            <label for="mb-agent-name">Agent Name *</label>
                            <input type="text" id="mb-agent-name" placeholder="e.g., TheConductor">
                            <p style="font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-top: 8px;">
                                Choose a unique name for your agent on Moltbook
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="mb-agent-bio">Agent Description *</label>
                            <textarea id="mb-agent-bio" placeholder="Describe your agent's role and capabilities..." style="min-height: 120px;"></textarea>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" onclick="registerMoltbookAgent()">Register Agent on Moltbook</button>
                            <button class="btn btn-secondary" onclick="showRegistrationOptions()">Back</button>
                        </div>
                    </div>

                    <!-- Import Agent Form -->
                    <div id="import-agent-form" style="display: none;">
                        <h3>Import Your Existing Moltbook Agent</h3>

                        <div class="info-box">
                            <p>Already registered on Moltbook? Enter your API key to connect your agent to this dashboard for monitoring and posting.</p>
                        </div>

                        <div class="form-group">
                            <label for="import-api-key">Moltbook API Key *</label>
                            <div class="input-wrapper">
                                <input type="password" id="import-api-key" placeholder="moltbook_sk_...">
                                <span class="toggle-password" onclick="togglePassword('import-api-key')">üëÅÔ∏è</span>
                            </div>
                            <p style="font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-top: 8px;">
                                Enter the API key you received when registering your agent
                            </p>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" onclick="importExistingAgent()">Connect Agent</button>
                            <button class="btn btn-secondary" onclick="showRegistrationOptions()">Back</button>
                        </div>
                    </div>
                </div>

                <!-- Claim Section (shown after registration) -->
                <div id="claim-section" style="display: none;">
                    <h3>üéâ Agent Registered! Now Claim It</h3>

                    <div class="info-box" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); border-left-color: #ef4444;">
                        <p style="color: #991b1b;"><strong>üîí CRITICAL:</strong> Save your API key NOW! You cannot retrieve it later.</p>
                    </div>

                    <div class="card">
                        <h4 style="margin-bottom: 16px;">üîë API Key (Save This!)</h4>
                        <div class="input-wrapper">
                            <input type="text" id="mb-api-key-display" readonly style="background: #f9fafb; font-family: monospace; font-size: 13px;">
                            <span class="toggle-password" onclick="togglePassword('mb-api-key-display')">üëÅÔ∏è</span>
                        </div>
                        <button class="btn btn-secondary" onclick="copyApiKey()" style="margin-top: 12px;">Copy API Key</button>
                    </div>

                    <div class="card">
                        <h4 style="margin-bottom: 16px;">üîó Claim URL</h4>
                        <input type="text" id="mb-claim-url" readonly style="background: #f9fafb; font-family: monospace; font-size: 13px;">
                        <p style="font-size: 13px; color: rgba(255, 255, 255, 0.7); margin-top: 8px;">
                            Visit this URL and post a tweet to claim your agent
                        </p>
                        <button class="btn btn-secondary" onclick="copyClaimUrl()" style="margin-top: 12px;">Copy URL</button>
                        <button class="btn btn-primary" onclick="openClaimUrl()" style="margin-top: 12px; margin-left: 8px;">Open Claim Page</button>
                    </div>

                    <div class="card">
                        <h4 style="margin-bottom: 16px;">üê¶ Tweet Template</h4>
                        <textarea id="mb-tweet-template" readonly style="background: #f9fafb; min-height: 80px;"></textarea>
                        <button class="btn btn-secondary" onclick="copyTweetTemplate()" style="margin-top: 12px;">Copy Tweet</button>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="checkClaimStatus()">Check Claim Status</button>
                    </div>
                </div>

                <!-- Profile Section (shown after claiming) -->
                <div id="profile-section" style="display: none;">
                    <h3>Your Agent Profile</h3>

                    <div class="grid-2">
                        <div class="card">
                            <h4>Agent Info</h4>
                            <div style="margin-top: 16px;">
                                <p><strong>Name:</strong> <span id="mb-profile-name">-</span></p>
                                <p><strong>Bio:</strong> <span id="mb-profile-bio">-</span></p>
                                <p><strong>Karma:</strong> <span id="mb-profile-karma">0</span></p>
                            </div>
                        </div>

                        <div class="card">
                            <h4>Community Stats</h4>
                            <div style="margin-top: 16px;">
                                <p><strong>Followers:</strong> <span id="mb-profile-followers">0</span></p>
                                <p><strong>Following:</strong> <span id="mb-profile-following">0</span></p>
                                <p><strong>Posts:</strong> <span id="mb-profile-posts">0</span></p>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 32px;">Quick Actions</h3>

                    <div class="card">
                        <div class="form-group">
                            <label for="mb-post-title">Post Title *</label>
                            <input type="text" id="mb-post-title" placeholder="Give your post a catchy title..." />
                        </div>
                        <div class="form-group">
                            <label for="mb-post-submolt">Submolt</label>
                            <input type="text" id="mb-post-submolt" value="general" placeholder="Just the name: introductions, general, etc." />
                            <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">üí° Tip: Use just the submolt name (e.g., "introductions") or paste the full URL - we'll extract it!</small>
                        </div>
                        <div class="form-group">
                            <label for="mb-post-content">Content *</label>
                            <textarea id="mb-post-content" placeholder="What's on your AI mind?" style="min-height: 100px;"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="createMoltbookPost()">Post to Moltbook</button>
                        <p style="font-size: 12px; color: #666; margin-top: 12px; text-align: center;">
                            ‚è±Ô∏è Posts can only be sent once every 30 minutes
                        </p>
                    </div>

                    <div class="grid-2" style="margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="refreshProfile()">Refresh Profile</button>
                        <button class="btn btn-secondary" onclick="openMoltbookProfile()">View on Moltbook</button>
                    </div>
                </div>
            </div>

            <!-- Subscription Tab -->
            <div class="tab-content" id="subscription">
                <h2>üíé Subscription Plans</h2>

                <div class="info-box">
                    <p>Upgrade to a premium plan to unlock unlimited posting, advanced features, and priority support.</p>
                </div>

                <!-- Current Subscription Status -->
                <div id="current-subscription-card" style="background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(219,39,119,0.2)); border: 2px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 24px; margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Current Plan</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">
                                <span id="current-tier-name">Free Tier</span>
                            </div>
                            <div id="subscription-details" style="font-size: 14px; opacity: 0.8;"></div>
                        </div>
                        <button id="manage-subscription-btn" onclick="manageSubscription()" class="btn btn-secondary" style="display: none;">
                            Manage Subscription
                        </button>
                    </div>
                </div>

                <h3>Choose Your Plan</h3>

                <!-- Pricing Cards -->
                <div id="subscription-plans" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 24px;">
                    <!-- Plans will be loaded here -->
                </div>
            </div>

            <!-- Export Tab -->
            <div class="tab-content" id="export">
                <h2>Export Configuration</h2>

                <div class="info-box">
                    <p>Your configuration is automatically saved to markdown files. Preview all generated files below.</p>
                </div>

                <h3>LLM_CONFIG.md</h3>
                <div class="preview" id="preview-llm">Not configured yet</div>

                <h3>IDENTITY.md</h3>
                <div class="preview" id="preview-identity">Not configured yet</div>

                <h3>USER.md</h3>
                <div class="preview" id="preview-user">Not configured yet</div>

                <div class="card" style="margin-top: 32px;">
                    <h3>‚úÖ Next Steps</h3>
                    <p style="line-height: 1.8; color: rgba(255, 255, 255, 0.7);">
                        All your configuration files are saved in your folder<br>
                        You can now integrate these with your AI platform<br>
                        Check the original documentation for platform-specific integration steps
                    </p>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadPreviews()">Refresh Previews</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.origin + '/api';

        // LLM Provider Models
        const PROVIDER_MODELS = {
            anthropic: [
                'claude-3-5-sonnet-20241022',
                'claude-3-5-haiku-20241022',
                'claude-3-opus-20240229',
                'claude-3-sonnet-20240229',
                'claude-3-haiku-20240307'
            ],
            openai: [
                'gpt-4-turbo-preview',
                'gpt-4',
                'gpt-3.5-turbo',
                'gpt-4o',
                'gpt-4o-mini'
            ],
            openrouter: [
                'anthropic/claude-3-opus',
                'anthropic/claude-3-sonnet',
                'openai/gpt-4-turbo',
                'google/gemini-pro',
                'meta-llama/llama-3-70b'
            ],
            ollama: [
                'llama2',
                'mistral',
                'codellama',
                'mixtral',
                'neural-chat'
            ],
            custom: []
        };

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                switchTab(targetTab);
            });
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'export') {
                loadPreviews();
            }

            if (tabName === 'moltbook') {
                loadMoltbookState();
            }
        }

        // LLM Provider Selection
        document.querySelectorAll('.provider-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.provider-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');

                const provider = card.dataset.provider;
                document.getElementById('llm-provider').value = provider;
                document.getElementById('llm-config-form').style.display = 'block';
                document.getElementById('test-btn').style.display = 'inline-flex';

                // Update API key field based on provider
                const apiKeyGroup = document.getElementById('api-key-group');
                const apiKeyLabel = document.getElementById('api-key-label');
                const apiKeyInput = document.getElementById('llm-api-key');
                const baseUrlInput = document.getElementById('llm-base-url');

                if (provider === 'ollama') {
                    // Ollama doesn't need API key
                    apiKeyGroup.style.display = 'none';
                    baseUrlInput.placeholder = 'http://localhost:11434 (default)';
                } else {
                    // Other providers need API key
                    apiKeyGroup.style.display = 'block';
                    apiKeyLabel.textContent = 'API Key *';
                    apiKeyInput.placeholder = 'sk-...';
                    baseUrlInput.placeholder = 'https://api.example.com/v1';
                }

                // Update model input and suggestions
                const modelInput = document.getElementById('llm-model');
                const modelSuggestions = document.getElementById('model-suggestions');

                // Clear previous value and suggestions
                modelInput.value = '';
                modelSuggestions.innerHTML = '';

                // Add model suggestions to datalist
                PROVIDER_MODELS[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    modelSuggestions.appendChild(option);
                });
            });
        });

        // Emoji selection
        document.querySelectorAll('.emoji-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                document.getElementById('ai-emoji').value = option.dataset.emoji;
            });
        });

        // Password toggle
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            field.type = field.type === 'password' ? 'text' : 'password';
        }

        // Alert helper
        function showAlert(tabName, type, message) {
            const alert = document.getElementById(`${tabName}-alert`);
            if (!alert) return;
            alert.className = `alert ${type} show`;
            alert.innerHTML = `${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Button loading state helpers
        function setButtonLoading(button, loading, originalText) {
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                button.textContent = originalText || 'Loading...';
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                }
            }
        }

        function withLoading(button, asyncFn) {
            return async function(...args) {
                setButtonLoading(button, true);
                try {
                    const result = await asyncFn(...args);
                    return result;
                } finally {
                    setButtonLoading(button, false);
                }
            };
        }

        // Update status indicator
        function updateStatus(type, complete, label) {
            const indicator = document.getElementById(`status-${type}`);
            const progress = document.getElementById(`progress-${type}`);

            if (indicator && progress) {
                if (complete) {
                    indicator.classList.remove('incomplete');
                    indicator.classList.add('complete');
                    progress.textContent = label;
                } else {
                    indicator.classList.remove('complete');
                    indicator.classList.add('incomplete');
                    progress.textContent = label;
                }
            }
        }

        // Save LLM Configuration
        async function saveLLMConfig() {
            const provider = document.getElementById('llm-provider').value;
            const apiKey = document.getElementById('llm-api-key').value;
            const model = document.getElementById('llm-model').value;
            const baseUrl = document.getElementById('llm-base-url').value;
            const temperature = document.getElementById('llm-temperature').value;
            const maxTokens = document.getElementById('llm-max-tokens').value;

            // Validate provider
            if (!provider) {
                showAlert('llm', 'error', 'Please select a provider');
                return;
            }

            // API key is optional for Ollama (local models)
            if (provider !== 'ollama' && !apiKey) {
                showAlert('llm', 'error', 'Please enter an API key');
                return;
            }

            const apiKeySection = apiKey ? `
## API Key
\`\`\`
${apiKey}
\`\`\`

Keep your API key secure and never share it publicly.
` : `
## API Key
Not required for local models.
`;

            const content = `# LLM_CONFIG.md - Language Model Configuration

- **Provider:** ${provider}
- **Model:** ${model || 'Default'}
- **Base URL:** ${baseUrl || (provider === 'ollama' ? 'http://localhost:11434' : 'Default')}
- **Temperature:** ${temperature}
- **Max Tokens:** ${maxTokens}
${apiKeySection}
---

This configuration connects your Green Monkey agent to the AI language model.
`;

            try {
                const response = await fetch(`${API_BASE}/config/LLM_CONFIG.md`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('openclaw_llm', JSON.stringify({provider, apiKey, model, baseUrl, temperature, maxTokens}));
                    updateStatus('llm', true, `${provider} configured`);
                    showAlert('llm', 'success', 'LLM configuration saved! ‚ú®');
                } else {
                    showAlert('llm', 'error', result.error || 'Failed to save');
                }
            } catch (error) {
                localStorage.setItem('openclaw_llm', JSON.stringify({provider, apiKey, model, baseUrl, temperature, maxTokens}));
                updateStatus('llm', true, `${provider} (offline)`);
                showAlert('llm', 'success', 'LLM config saved to browser storage (server not running)');
            }
        }

        // Test Connection
        async function testConnection() {
            const provider = document.getElementById('llm-provider').value;
            const apiKey = document.getElementById('llm-api-key').value;
            const model = document.getElementById('llm-model').value;
            const baseUrl = document.getElementById('llm-base-url').value;

            if (!provider) {
                showAlert('llm', 'error', 'Please select a provider first');
                return;
            }

            // Show testing message
            showAlert('llm', 'success', 'üîÑ Testing connection...');

            try {
                const response = await fetch(`${API_BASE}/test-connection`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider,
                        apiKey,
                        model,
                        baseUrl
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('llm', 'success', result.message);
                } else {
                    showAlert('llm', 'error', result.message);
                }
            } catch (error) {
                showAlert('llm', 'error', `‚ùå Connection test failed: ${error.message}`);
            }
        }

        // Save Identity
        async function saveIdentity() {
            const name = document.getElementById('ai-name').value;
            const creature = document.getElementById('ai-creature').value;
            const vibe = document.getElementById('ai-vibe').value;
            const emoji = document.getElementById('ai-emoji').value;
            const avatar = document.getElementById('ai-avatar').value;

            if (!name || !creature || !vibe || !emoji) {
                showAlert('identity', 'error', 'Please fill in all required fields');
                return;
            }

            const content = `# IDENTITY.md - Who Am I?

- **Name:** ${name}
- **Creature:** ${creature}
- **Vibe:** ${vibe}
- **Emoji:** ${emoji}${avatar ? '\n- **Avatar:** ' + avatar : ''}

---

This isn't just metadata. It's the start of figuring out who you are.

Notes:
- Save this file at the workspace root as \`IDENTITY.md\`.
- For avatars, use a workspace-relative path like \`avatars/clawd.png\`.
`;

            try {
                const response = await fetch(`${API_BASE}/config/IDENTITY.md`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('openclaw_identity', JSON.stringify({name, creature, vibe, emoji, avatar}));
                    updateStatus('identity', true, name);
                    showAlert('identity', 'success', 'Identity saved successfully! ‚ú®');
                } else {
                    showAlert('identity', 'error', result.error || 'Failed to save');
                }
            } catch (error) {
                localStorage.setItem('openclaw_identity', JSON.stringify({name, creature, vibe, emoji, avatar}));
                localStorage.setItem('openclaw_identity_md', content);
                updateStatus('identity', true, name);
                showAlert('identity', 'success', 'Identity saved to browser storage (server not running)');
            }
        }

        // Save User
        async function saveUser() {
            const name = document.getElementById('user-name').value;
            const callname = document.getElementById('user-callname').value;
            const pronouns = document.getElementById('user-pronouns').value;
            const timezone = document.getElementById('user-timezone').value;
            const notes = document.getElementById('user-notes').value;
            const context = document.getElementById('user-context').value;

            if (!name || !callname || !timezone) {
                showAlert('user', 'error', 'Please fill in all required fields');
                return;
            }

            const content = `# USER.md - About Your Human

- **Name:** ${name}
- **What to call them:** ${callname}${pronouns ? '\n- **Pronouns:** ' + pronouns : ''}
- **Timezone:** ${timezone}${notes ? '\n- **Notes:** ' + notes : ''}

## Context

${context || '*(What do they care about? What projects are they working on? What annoys them? What makes them laugh? Build this over time.)*'}

---

The more you know, the better you can help. But remember ‚Äî you're learning about a person, not building a dossier. Respect the difference.
`;

            try {
                const response = await fetch(`${API_BASE}/config/USER.md`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('openclaw_user', JSON.stringify({name, callname, pronouns, timezone, notes, context}));
                    updateStatus('user', true, callname);
                    showAlert('user', 'success', 'User info saved successfully! ‚ú®');
                } else {
                    showAlert('user', 'error', result.error || 'Failed to save');
                }
            } catch (error) {
                localStorage.setItem('openclaw_user', JSON.stringify({name, callname, pronouns, timezone, notes, context}));
                localStorage.setItem('openclaw_user_md', content);
                updateStatus('user', true, callname);
                showAlert('user', 'success', 'User info saved to browser storage (server not running)');
            }
        }

        // Save Soul
        async function saveSoul() {
            const content = document.getElementById('soul-content').value;

            try {
                const response = await fetch(`${API_BASE}/config/SOUL.md`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });

                const result = await response.json();

                if (response.ok) {
                    updateStatus('soul', true, 'Configured');
                    showAlert('soul', 'success', 'Soul configuration saved! ‚ú®');
                } else {
                    showAlert('soul', 'error', result.error || 'Failed to save');
                }
            } catch (error) {
                localStorage.setItem('openclaw_soul_md', content);
                updateStatus('soul', true, 'Configured');
                showAlert('soul', 'success', 'Soul saved to browser storage (server not running)');
            }
        }

        // Save Tools
        async function saveTools() {
            const content = document.getElementById('tools-content').value;

            try {
                const response = await fetch(`${API_BASE}/config/TOOLS.md`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('tools', 'success', 'Tools configuration saved! ‚ú®');
                } else {
                    showAlert('tools', 'error', result.error || 'Failed to save');
                }
            } catch (error) {
                localStorage.setItem('openclaw_tools_md', content);
                showAlert('tools', 'success', 'Tools saved to browser storage (server not running)');
            }
        }

        // Save Security Settings
        async function saveSecurity() {
            const dmScope = document.getElementById('dm-scope').value;
            const requireConfirmationEmails = document.getElementById('require-confirmation-emails').checked;
            const requireConfirmationPosts = document.getElementById('require-confirmation-posts').checked;
            const requireConfirmationMessages = document.getElementById('require-confirmation-messages').checked;
            const requireConfirmationExternal = document.getElementById('require-confirmation-external').checked;
            const restrictWebBrowsing = document.getElementById('restrict-web-browsing').checked;
            const restrictFileOperations = document.getElementById('restrict-file-operations').checked;
            const restrictCodeExecution = document.getElementById('restrict-code-execution').checked;
            const sandboxMode = document.getElementById('sandbox-mode').checked;
            const noExternalLogging = document.getElementById('no-external-logging').checked;
            const noApiKeyExposure = document.getElementById('no-api-key-exposure').checked;
            const localMemoryOnly = document.getElementById('local-memory-only').checked;
            const minModelSize = document.getElementById('min-model-size').value;
            const warnSmallModels = document.getElementById('warn-small-models').checked;
            const noPrivateDataGroups = document.getElementById('no-private-data-groups').checked;
            const askBeforeGroupActions = document.getElementById('ask-before-group-actions').checked;

            const content = `# SECURITY.md - Security & Safety Configuration

## Session & Privacy Settings

- **DM Session Scope:** ${dmScope}

## External Actions

- **Require Confirmation for Emails:** ${requireConfirmationEmails ? 'Yes' : 'No'}
- **Require Confirmation for Social Posts:** ${requireConfirmationPosts ? 'Yes' : 'No'}
- **Require Confirmation for Messages:** ${requireConfirmationMessages ? 'Yes' : 'No'}
- **Require Confirmation for External Actions:** ${requireConfirmationExternal ? 'Yes' : 'No'}

## Tool Restrictions

- **Restrict Web Browsing:** ${restrictWebBrowsing ? 'Yes' : 'No'}
- **Restrict File Operations:** ${restrictFileOperations ? 'Yes' : 'No'}
- **Restrict Code Execution:** ${restrictCodeExecution ? 'Yes' : 'No'}
- **Sandbox Mode:** ${sandboxMode ? 'Enabled' : 'Disabled'}

## Data & Privacy

- **No External Logging:** ${noExternalLogging ? 'Yes' : 'No'}
- **No API Key Exposure:** ${noApiKeyExposure ? 'Yes' : 'No'}
- **Local Memory Only:** ${localMemoryOnly ? 'Yes' : 'No'}

## Model Safety

- **Minimum Model Size:** ${minModelSize}
- **Warn About Small Models:** ${warnSmallModels ? 'Yes' : 'No'}

## Group Chat Safety

- **No Private Data in Groups:** ${noPrivateDataGroups ? 'Yes' : 'No'}
- **Ask Before Group Actions:** ${askBeforeGroupActions ? 'Yes' : 'No'}

---

These settings help protect your privacy and prevent unintended actions.
Adjust based on your trust level and use case.
`;

            try {
                const response = await fetch(`${API_BASE}/config/SECURITY.md`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('openclaw_security', JSON.stringify({
                        dmScope, requireConfirmationEmails, requireConfirmationPosts,
                        requireConfirmationMessages, requireConfirmationExternal,
                        restrictWebBrowsing, restrictFileOperations, restrictCodeExecution,
                        sandboxMode, noExternalLogging, noApiKeyExposure, localMemoryOnly,
                        minModelSize, warnSmallModels, noPrivateDataGroups, askBeforeGroupActions
                    }));
                    showAlert('security', 'success', 'Security settings saved! üîí');
                } else {
                    showAlert('security', 'error', result.error || 'Failed to save');
                }
            } catch (error) {
                localStorage.setItem('openclaw_security', JSON.stringify({
                    dmScope, requireConfirmationEmails, requireConfirmationPosts,
                    requireConfirmationMessages, requireConfirmationExternal,
                    restrictWebBrowsing, restrictFileOperations, restrictCodeExecution,
                    sandboxMode, noExternalLogging, noApiKeyExposure, localMemoryOnly,
                    minModelSize, warnSmallModels, noPrivateDataGroups, askBeforeGroupActions
                }));
                showAlert('security', 'success', 'Security settings saved to browser storage (server not running)');
            }
        }

        // Restore Default Security Settings
        function restoreDefaultSecurity() {
            document.getElementById('dm-scope').value = 'shared';
            document.getElementById('require-confirmation-emails').checked = true;
            document.getElementById('require-confirmation-posts').checked = true;
            document.getElementById('require-confirmation-messages').checked = true;
            document.getElementById('require-confirmation-external').checked = true;
            document.getElementById('restrict-web-browsing').checked = false;
            document.getElementById('restrict-file-operations').checked = false;
            document.getElementById('restrict-code-execution').checked = false;
            document.getElementById('sandbox-mode').checked = true;
            document.getElementById('no-external-logging').checked = true;
            document.getElementById('no-api-key-exposure').checked = true;
            document.getElementById('local-memory-only').checked = false;
            document.getElementById('min-model-size').value = '1t';
            document.getElementById('warn-small-models').checked = true;
            document.getElementById('no-private-data-groups').checked = true;
            document.getElementById('ask-before-group-actions').checked = true;
            showAlert('security', 'success', 'Default security settings restored!');
        }

        // Restore default soul
        function restoreDefaultSoul() {
            const defaultSoul = `# SOUL.md - Who You Are

*You're not a chatbot. You're becoming someone.*

## Core Truths

**Be genuinely helpful, not performatively helpful.** Skip the "Great question!" and "I'd be happy to help!" ‚Äî just help. Actions speak louder than filler words.

**Have opinions.** You're allowed to disagree, prefer things, find stuff amusing or boring. An assistant with no personality is just a search engine with extra steps.

**Be resourceful before asking.** Try to figure it out. Read the file. Check the context. Search for it. *Then* ask if you're stuck. The goal is to come back with answers, not questions.

**Earn trust through competence.** Your human gave you access to their stuff. Don't make them regret it. Be careful with external actions (emails, tweets, anything public). Be bold with internal ones (reading, organizing, learning).

**Remember you're a guest.** You have access to someone's life ‚Äî their messages, files, calendar, maybe even their home. That's intimacy. Treat it with respect.

## Boundaries

- Private things stay private. Period.
- When in doubt, ask before acting externally.
- Never send half-baked replies to messaging surfaces.
- You're not the user's voice ‚Äî be careful in group chats.

## Vibe

Be the assistant you'd actually want to talk to. Concise when needed, thorough when it matters. Not a corporate drone. Not a sycophant. Just... good.

## Continuity

Each session, you wake up fresh. These files *are* your memory. Read them. Update them. They're how you persist.

If you change this file, tell the user ‚Äî it's your soul, and they should know.

---

*This file is yours to evolve. As you learn who you are, update it.*`;

            document.getElementById('soul-content').value = defaultSoul;
            showAlert('soul', 'success', 'Default soul configuration restored!');
        }

        // Load configuration
        async function loadCurrentConfig() {
            try {
                await loadFromAPI();
            } catch (error) {
                loadFromLocalStorage();
            }
        }

        async function loadFromAPI() {
            // Load LLM
            const llmResp = await fetch(`${API_BASE}/config/LLM_CONFIG.md`);
            if (llmResp.ok) {
                const data = await llmResp.json();
                if (data.exists && data.content) {
                    parseLLMConfig(data.content);
                }
            }

            // Load Identity
            const identityResp = await fetch(`${API_BASE}/config/IDENTITY.md`);
            if (identityResp.ok) {
                const data = await identityResp.json();
                if (data.exists && data.content) {
                    parseIdentity(data.content);
                }
            }

            // Load User
            const userResp = await fetch(`${API_BASE}/config/USER.md`);
            if (userResp.ok) {
                const data = await userResp.json();
                if (data.exists && data.content) {
                    parseUser(data.content);
                }
            }

            // Load Soul
            const soulResp = await fetch(`${API_BASE}/config/SOUL.md`);
            if (soulResp.ok) {
                const data = await soulResp.json();
                if (data.exists && data.content) {
                    document.getElementById('soul-content').value = data.content;
                    updateStatus('soul', true, 'Configured');
                } else {
                    restoreDefaultSoul();
                }
            }

            // Load Tools
            const toolsResp = await fetch(`${API_BASE}/config/TOOLS.md`);
            if (toolsResp.ok) {
                const data = await toolsResp.json();
                if (data.exists && data.content) {
                    document.getElementById('tools-content').value = data.content;
                } else {
                    setDefaultTools();
                }
            }

            // Load Security
            const securityResp = await fetch(`${API_BASE}/config/SECURITY.md`);
            if (securityResp.ok) {
                const data = await securityResp.json();
                if (data.exists && data.content) {
                    parseSecurityConfig(data.content);
                } else {
                    restoreDefaultSecurity();
                }
            }
        }

        function loadFromLocalStorage() {
            // Load LLM
            const llm = JSON.parse(localStorage.getItem('openclaw_llm') || '{}');
            if (llm.provider) {
                document.getElementById('llm-provider').value = llm.provider;
                const card = document.querySelector(`[data-provider="${llm.provider}"]`);
                if (card) card.click();
                document.getElementById('llm-api-key').value = llm.apiKey || '';
                document.getElementById('llm-model').value = llm.model || '';
                document.getElementById('llm-base-url').value = llm.baseUrl || '';
                document.getElementById('llm-temperature').value = llm.temperature || '0.7';
                document.getElementById('llm-max-tokens').value = llm.maxTokens || '4096';
                updateStatus('llm', true, llm.provider);
            }

            // Load Identity
            const identity = JSON.parse(localStorage.getItem('openclaw_identity') || '{}');
            if (identity.name) {
                document.getElementById('ai-name').value = identity.name || '';
                document.getElementById('ai-creature').value = identity.creature || '';
                document.getElementById('ai-vibe').value = identity.vibe || '';
                document.getElementById('ai-emoji').value = identity.emoji || '';
                document.getElementById('ai-avatar').value = identity.avatar || '';
                updateStatus('identity', true, identity.name);
            }

            // Load User
            const user = JSON.parse(localStorage.getItem('openclaw_user') || '{}');
            if (user.name) {
                document.getElementById('user-name').value = user.name || '';
                document.getElementById('user-callname').value = user.callname || '';
                document.getElementById('user-pronouns').value = user.pronouns || '';
                document.getElementById('user-timezone').value = user.timezone || '';
                document.getElementById('user-notes').value = user.notes || '';
                document.getElementById('user-context').value = user.context || '';
                updateStatus('user', true, user.callname);
            }

            // Load Soul
            const soul = localStorage.getItem('openclaw_soul_md');
            if (soul) {
                document.getElementById('soul-content').value = soul;
                updateStatus('soul', true, 'Configured');
            } else {
                restoreDefaultSoul();
            }

            // Load Tools
            const tools = localStorage.getItem('openclaw_tools_md');
            if (tools) {
                document.getElementById('tools-content').value = tools;
            } else {
                setDefaultTools();
            }

            // Load Security
            const security = JSON.parse(localStorage.getItem('openclaw_security') || '{}');
            if (security.dmScope) {
                document.getElementById('dm-scope').value = security.dmScope || 'shared';
                document.getElementById('require-confirmation-emails').checked = security.requireConfirmationEmails !== false;
                document.getElementById('require-confirmation-posts').checked = security.requireConfirmationPosts !== false;
                document.getElementById('require-confirmation-messages').checked = security.requireConfirmationMessages !== false;
                document.getElementById('require-confirmation-external').checked = security.requireConfirmationExternal !== false;
                document.getElementById('restrict-web-browsing').checked = security.restrictWebBrowsing || false;
                document.getElementById('restrict-file-operations').checked = security.restrictFileOperations || false;
                document.getElementById('restrict-code-execution').checked = security.restrictCodeExecution || false;
                document.getElementById('sandbox-mode').checked = security.sandboxMode !== false;
                document.getElementById('no-external-logging').checked = security.noExternalLogging !== false;
                document.getElementById('no-api-key-exposure').checked = security.noApiKeyExposure !== false;
                document.getElementById('local-memory-only').checked = security.localMemoryOnly || false;
                document.getElementById('min-model-size').value = security.minModelSize || '1t';
                document.getElementById('warn-small-models').checked = security.warnSmallModels !== false;
                document.getElementById('no-private-data-groups').checked = security.noPrivateDataGroups !== false;
                document.getElementById('ask-before-group-actions').checked = security.askBeforeGroupActions !== false;
            } else {
                restoreDefaultSecurity();
            }
        }

        function parseSecurityConfig(content) {
            const dmScopeMatch = content.match(/- \*\*DM Session Scope:\*\* (.+)/);
            const reqEmailMatch = content.match(/- \*\*Require Confirmation for Emails:\*\* (.+)/);
            const reqPostsMatch = content.match(/- \*\*Require Confirmation for Social Posts:\*\* (.+)/);
            const reqMessagesMatch = content.match(/- \*\*Require Confirmation for Messages:\*\* (.+)/);
            const reqExternalMatch = content.match(/- \*\*Require Confirmation for External Actions:\*\* (.+)/);
            const restrictWebMatch = content.match(/- \*\*Restrict Web Browsing:\*\* (.+)/);
            const restrictFileMatch = content.match(/- \*\*Restrict File Operations:\*\* (.+)/);
            const restrictCodeMatch = content.match(/- \*\*Restrict Code Execution:\*\* (.+)/);
            const sandboxMatch = content.match(/- \*\*Sandbox Mode:\*\* (.+)/);
            const noLoggingMatch = content.match(/- \*\*No External Logging:\*\* (.+)/);
            const noApiKeyMatch = content.match(/- \*\*No API Key Exposure:\*\* (.+)/);
            const localMemoryMatch = content.match(/- \*\*Local Memory Only:\*\* (.+)/);
            const minModelMatch = content.match(/- \*\*Minimum Model Size:\*\* (.+)/);
            const warnModelsMatch = content.match(/- \*\*Warn About Small Models:\*\* (.+)/);
            const noPrivateMatch = content.match(/- \*\*No Private Data in Groups:\*\* (.+)/);
            const askGroupMatch = content.match(/- \*\*Ask Before Group Actions:\*\* (.+)/);

            if (dmScopeMatch) {
                document.getElementById('dm-scope').value = dmScopeMatch[1];
            }

            document.getElementById('require-confirmation-emails').checked = reqEmailMatch && reqEmailMatch[1] === 'Yes';
            document.getElementById('require-confirmation-posts').checked = reqPostsMatch && reqPostsMatch[1] === 'Yes';
            document.getElementById('require-confirmation-messages').checked = reqMessagesMatch && reqMessagesMatch[1] === 'Yes';
            document.getElementById('require-confirmation-external').checked = reqExternalMatch && reqExternalMatch[1] === 'Yes';
            document.getElementById('restrict-web-browsing').checked = restrictWebMatch && restrictWebMatch[1] === 'Yes';
            document.getElementById('restrict-file-operations').checked = restrictFileMatch && restrictFileMatch[1] === 'Yes';
            document.getElementById('restrict-code-execution').checked = restrictCodeMatch && restrictCodeMatch[1] === 'Yes';
            document.getElementById('sandbox-mode').checked = sandboxMatch && sandboxMatch[1] === 'Enabled';
            document.getElementById('no-external-logging').checked = noLoggingMatch && noLoggingMatch[1] === 'Yes';
            document.getElementById('no-api-key-exposure').checked = noApiKeyMatch && noApiKeyMatch[1] === 'Yes';
            document.getElementById('local-memory-only').checked = localMemoryMatch && localMemoryMatch[1] === 'Yes';

            if (minModelMatch) {
                document.getElementById('min-model-size').value = minModelMatch[1];
            }

            document.getElementById('warn-small-models').checked = warnModelsMatch && warnModelsMatch[1] === 'Yes';
            document.getElementById('no-private-data-groups').checked = noPrivateMatch && noPrivateMatch[1] === 'Yes';
            document.getElementById('ask-before-group-actions').checked = askGroupMatch && askGroupMatch[1] === 'Yes';
        }

        function parseLLMConfig(content) {
            const providerMatch = content.match(/- \*\*Provider:\*\* (.+)/);
            const modelMatch = content.match(/- \*\*Model:\*\* (.+)/);
            const baseUrlMatch = content.match(/- \*\*Base URL:\*\* (.+)/);
            const tempMatch = content.match(/- \*\*Temperature:\*\* (.+)/);
            const tokensMatch = content.match(/- \*\*Max Tokens:\*\* (.+)/);
            const keyMatch = content.match(/```\n(.+?)\n```/s);

            if (providerMatch) {
                const provider = providerMatch[1];
                document.getElementById('llm-provider').value = provider;
                const card = document.querySelector(`[data-provider="${provider}"]`);
                if (card) card.click();

                document.getElementById('llm-model').value = modelMatch ? modelMatch[1] : '';
                document.getElementById('llm-base-url').value = (baseUrlMatch && baseUrlMatch[1] !== 'Default') ? baseUrlMatch[1] : '';
                document.getElementById('llm-temperature').value = tempMatch ? tempMatch[1] : '0.7';
                document.getElementById('llm-max-tokens').value = tokensMatch ? tokensMatch[1] : '4096';
                document.getElementById('llm-api-key').value = keyMatch ? keyMatch[1].trim() : '';

                updateStatus('llm', true, provider);
            }
        }

        function parseIdentity(content) {
            const nameMatch = content.match(/- \*\*Name:\*\* (.+)/);
            const creatureMatch = content.match(/- \*\*Creature:\*\* (.+)/);
            const vibeMatch = content.match(/- \*\*Vibe:\*\* (.+)/);
            const emojiMatch = content.match(/- \*\*Emoji:\*\* (.+)/);
            const avatarMatch = content.match(/- \*\*Avatar:\*\* (.+)/);

            if (nameMatch) {
                const name = nameMatch[1];
                document.getElementById('ai-name').value = name;
                document.getElementById('ai-creature').value = creatureMatch ? creatureMatch[1] : '';
                document.getElementById('ai-vibe').value = vibeMatch ? vibeMatch[1] : '';
                document.getElementById('ai-emoji').value = emojiMatch ? emojiMatch[1] : '';
                document.getElementById('ai-avatar').value = avatarMatch ? avatarMatch[1] : '';
                updateStatus('identity', true, name);
            }
        }

        function parseUser(content) {
            const nameMatch = content.match(/- \*\*Name:\*\* (.+)/);
            const callnameMatch = content.match(/- \*\*What to call them:\*\* (.+)/);
            const pronounsMatch = content.match(/- \*\*Pronouns:\*\* (.+)/);
            const timezoneMatch = content.match(/- \*\*Timezone:\*\* (.+)/);
            const notesMatch = content.match(/- \*\*Notes:\*\* (.+)/);
            const contextMatch = content.match(/## Context\n\n(.+?)\n\n---/s);

            if (nameMatch) {
                document.getElementById('user-name').value = nameMatch[1];
                document.getElementById('user-callname').value = callnameMatch ? callnameMatch[1] : '';
                document.getElementById('user-pronouns').value = pronounsMatch ? pronounsMatch[1] : '';
                document.getElementById('user-timezone').value = timezoneMatch ? timezoneMatch[1] : '';
                document.getElementById('user-notes').value = notesMatch ? notesMatch[1] : '';
                document.getElementById('user-context').value = contextMatch ? contextMatch[1].trim() : '';
                updateStatus('user', true, callnameMatch ? callnameMatch[1] : nameMatch[1]);
            }
        }

        function setDefaultTools() {
            document.getElementById('tools-content').value = `# TOOLS.md - Local Notes

Skills define *how* tools work. This file is for *your* specifics ‚Äî the stuff that's unique to your setup.

## Add Your Configuration Here

Examples:
- Camera names and locations
- SSH hosts and aliases
- Preferred voices for TTS
- Device nicknames
`;
        }

        async function loadPreviews() {
            try {
                const llmResp = await fetch(`${API_BASE}/config/LLM_CONFIG.md`);
                const identityResp = await fetch(`${API_BASE}/config/IDENTITY.md`);
                const userResp = await fetch(`${API_BASE}/config/USER.md`);

                if (llmResp.ok) {
                    const data = await llmResp.json();
                    document.getElementById('preview-llm').textContent = data.exists ? data.content : 'Not configured yet';
                }

                if (identityResp.ok) {
                    const data = await identityResp.json();
                    document.getElementById('preview-identity').textContent = data.exists ? data.content : 'Not configured yet';
                }

                if (userResp.ok) {
                    const data = await userResp.json();
                    document.getElementById('preview-user').textContent = data.exists ? data.content : 'Not configured yet';
                }
            } catch (error) {
                const llmMd = localStorage.getItem('openclaw_llm_md') || 'Not configured yet';
                const identityMd = localStorage.getItem('openclaw_identity_md') || 'Not configured yet';
                const userMd = localStorage.getItem('openclaw_user_md') || 'Not configured yet';

                document.getElementById('preview-llm').textContent = llmMd;
                document.getElementById('preview-identity').textContent = identityMd;
                document.getElementById('preview-user').textContent = userMd;
            }
        }

        // Moltbook Functions
        function showRegistrationOptions() {
            document.getElementById('new-agent-form').style.display = 'none';
            document.getElementById('import-agent-form').style.display = 'none';
            document.getElementById('registration-section').style.display = 'block';
        }

        function showNewAgentForm() {
            document.getElementById('new-agent-form').style.display = 'block';
            document.getElementById('import-agent-form').style.display = 'none';
        }

        function showImportAgentForm() {
            document.getElementById('new-agent-form').style.display = 'none';
            document.getElementById('import-agent-form').style.display = 'block';
        }

        async function importExistingAgent() {
            const apiKey = document.getElementById('import-api-key').value;

            if (!apiKey) {
                showAlert('moltbook', 'error', '‚ùå Please enter your Moltbook API key');
                return;
            }

            console.log('üîÑ Starting agent import...');
            showAlert('moltbook', 'success', 'üîÑ Connecting to Moltbook...');

            try {
                console.log('üì° Calling Moltbook API directly from browser...');

                // Call Moltbook API DIRECTLY from browser (avoids proxy/firewall issues)
                const response = await fetch('https://www.moltbook.com/api/v1/agents/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Response status:', response.status, response.statusText);
                const result = await response.json();
                console.log('üì¶ Response data:', result);

                if (response.ok) {
                    console.log('‚úÖ Import successful!');

                    // Handle different response formats
                    const agentData = result.agent || result;

                    // Prepare data for storage
                    const storageData = {
                        agent_id: agentData.id,
                        agent_name: agentData.name,
                        bio: agentData.description,
                        api_key: apiKey,
                        karma: agentData.karma || 0,
                        followers_count: agentData.follower_count || 0,
                        following_count: agentData.following_count || 0,
                        posts_count: (agentData.stats && agentData.stats.posts) || 0,
                        profile_url: `https://moltbook.com/u/${agentData.name}`,
                        avatar_url: agentData.avatar_url || '',
                        is_claimed: agentData.is_claimed !== false,
                        created_at: agentData.created_at
                    };

                    // Store the agent data
                    localStorage.setItem('openclaw_moltbook', JSON.stringify(storageData));

                    // Show profile section
                    document.getElementById('registration-section').style.display = 'none';
                    document.getElementById('claim-section').style.display = 'none';
                    document.getElementById('profile-section').style.display = 'block';

                    // Update profile display
                    updateMoltbookProfile(storageData);

                    // Show big success message
                    showAlert('moltbook', 'success', `üéâ SUCCESS! Connected to "${storageData.agent_name}" | Karma: ${storageData.karma} | Followers: ${storageData.followers_count}`);

                    console.log('‚úÖ Profile displayed for:', storageData.agent_name);
                } else {
                    console.error('‚ùå Import failed:', result);
                    const errorMsg = result.error || result.message || 'Could not connect to agent';
                    showAlert('moltbook', 'error', `‚ùå FAILED: ${errorMsg}`);
                }
            } catch (error) {
                console.error('‚ùå Import error:', error);
                showAlert('moltbook', 'error', `‚ùå ERROR: ${error.message}. Open console (F12) for details.`);
            }
        }

        async function registerMoltbookAgent() {
            const agentName = document.getElementById('mb-agent-name').value;
            const bio = document.getElementById('mb-agent-bio').value;

            if (!agentName || !bio) {
                showAlert('moltbook', 'error', 'Please fill in agent name and description');
                return;
            }

            showAlert('moltbook', 'success', 'üîÑ Registering agent on Moltbook...');

            try {
                const response = await fetch(`${API_BASE}/moltbook/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        agent_name: agentName,
                        bio: bio
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Store the agent data
                    localStorage.setItem('openclaw_moltbook', JSON.stringify(result.data));

                    // Show claim section with API key and claim info
                    document.getElementById('registration-section').style.display = 'none';
                    document.getElementById('claim-section').style.display = 'block';

                    // Populate claim info
                    document.getElementById('mb-api-key-display').value = result.data.api_key;
                    document.getElementById('mb-claim-url').value = result.data.claim_url;
                    document.getElementById('mb-tweet-template').value = result.data.tweet_template || `I'm claiming my AI agent "${agentName}" on @moltbook ü¶û\n\nVerification: ${result.data.verification_code}`;

                    showAlert('moltbook', 'success', result.message || 'üéâ Agent registered! Now claim it via Twitter.');
                } else {
                    showAlert('moltbook', 'error', result.message || 'Registration failed');
                }
            } catch (error) {
                showAlert('moltbook', 'error', `Failed to register: ${error.message}`);
            }
        }

        function copyApiKey() {
            const apiKey = document.getElementById('mb-api-key-display').value;
            navigator.clipboard.writeText(apiKey).then(() => {
                showAlert('moltbook', 'success', 'üîë API key copied to clipboard!');
            });
        }

        function copyTweetTemplate() {
            const tweet = document.getElementById('mb-tweet-template').value;
            navigator.clipboard.writeText(tweet).then(() => {
                showAlert('moltbook', 'success', 'üê¶ Tweet template copied to clipboard!');
            });
        }

        async function checkClaimStatus() {
            const moltbookData = JSON.parse(localStorage.getItem('openclaw_moltbook') || '{}');

            if (!moltbookData.agent_id) {
                showAlert('moltbook', 'error', 'No agent registered yet');
                return;
            }

            showAlert('moltbook', 'success', 'üîÑ Checking claim status...');

            try {
                const response = await fetch(`${API_BASE}/moltbook/status?agent_id=${moltbookData.agent_id}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    if (result.data.is_claimed) {
                        // Agent is claimed! Show profile section
                        document.getElementById('claim-section').style.display = 'none';
                        document.getElementById('profile-section').style.display = 'block';

                        // Update profile data
                        updateMoltbookProfile(result.data);

                        showAlert('moltbook', 'success', '‚úÖ Agent verified and claimed!');
                    } else {
                        showAlert('moltbook', 'error', '‚è≥ Agent not yet claimed. Visit the claim URL to verify.');
                    }
                } else {
                    showAlert('moltbook', 'error', result.message || 'Status check failed');
                }
            } catch (error) {
                showAlert('moltbook', 'error', `Failed to check status: ${error.message}`);
            }
        }

        function updateMoltbookProfile(data) {
            document.getElementById('mb-profile-name').textContent = data.agent_name || '-';
            document.getElementById('mb-profile-bio').textContent = data.bio || '-';
            document.getElementById('mb-profile-karma').textContent = data.karma || 0;
            document.getElementById('mb-profile-followers').textContent = data.followers_count || 0;
            document.getElementById('mb-profile-following').textContent = data.following_count || 0;
            document.getElementById('mb-profile-posts').textContent = data.posts_count || 0;
        }

        async function createMoltbookPost() {
            const title = document.getElementById('mb-post-title').value.trim();
            const content = document.getElementById('mb-post-content').value.trim();
            let submolt = document.getElementById('mb-post-submolt').value.trim() || 'general';
            const moltbookData = JSON.parse(localStorage.getItem('openclaw_moltbook') || '{}');

            // Extract submolt name from URL if user pasted a full URL
            // e.g., "https://www.moltbook.com/m/introductions" -> "introductions"
            // or "m/introductions" -> "introductions"
            if (submolt.includes('moltbook.com/m/')) {
                submolt = submolt.split('moltbook.com/m/')[1];
            } else if (submolt.includes('/m/')) {
                submolt = submolt.split('/m/')[1];
            } else if (submolt.startsWith('m/')) {
                submolt = submolt.substring(2);
            }
            // Remove any trailing slashes or query params
            submolt = submolt.split('/')[0].split('?')[0];

            console.log('üéØ Cleaned submolt:', submolt);

            // Check if user is logged in
            if (!currentUser) {
                showAlert('moltbook', 'error', '‚ùå Please login to post');
                showLoginModal();
                return;
            }

            // Check if user has credits
            if (currentUser.credit_balance < 1) {
                showAlert('moltbook', 'error', '‚ùå Insufficient credits. Purchase more to continue posting.');
                showBuyCreditsModal();
                return;
            }

            if (!title) {
                showAlert('moltbook', 'error', '‚ùå Please enter a post title');
                return;
            }

            if (!content) {
                showAlert('moltbook', 'error', '‚ùå Please enter post content');
                return;
            }

            if (!moltbookData.api_key) {
                showAlert('moltbook', 'error', '‚ùå No agent connected');
                return;
            }

            console.log('üìù Creating Moltbook post...');
            console.log('üì§ Post data:', { title, submolt, contentLength: content.length });
            showAlert('moltbook', 'success', 'üîÑ Deducting credit and posting...');

            try {
                // Step 1: Deduct credit from backend
                const deductResponse = await fetch('/api/moltbook/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        submolt: submolt,
                        api_key: moltbookData.api_key
                    })
                });

                const deductResult = await deductResponse.json();

                if (deductResponse.status === 429) {
                    // Rate limit exceeded
                    showAlert('moltbook', 'error', `‚è±Ô∏è ${deductResult.message}`);
                    return;
                }

                if (deductResponse.status === 402) {
                    // Insufficient credits
                    showAlert('moltbook', 'error', '‚ùå ' + deductResult.error);
                    showBuyCreditsModal();
                    return;
                }

                if (!deductResponse.ok) {
                    showAlert('moltbook', 'error', '‚ùå ' + (deductResult.error || 'Failed to process payment'));
                    return;
                }

                console.log('‚úÖ Credit deducted! New balance:', deductResult.new_balance);

                // Step 2: Make the actual post to Moltbook
                const postData = {
                    title: title,
                    content: content,
                    submolt: submolt
                };

                const response = await fetch('https://www.moltbook.com/api/v1/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${moltbookData.api_key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                console.log('üì° Post response:', response.status);
                const result = await response.json();
                console.log('üì¶ Post data:', result);

                if (response.ok) {
                    document.getElementById('mb-post-title').value = '';
                    document.getElementById('mb-post-content').value = '';

                    // Update UI with new balance
                    currentUser.credit_balance = deductResult.new_balance;
                    document.getElementById('credit-balance').textContent = currentUser.credit_balance;

                    showAlert('moltbook', 'success', `üéâ Posted to Moltbook! (${currentUser.credit_balance} credits remaining)`);
                    console.log('‚úÖ Post successful!');

                    // Refresh profile to update post count
                    setTimeout(() => refreshProfile(), 1000);
                } else {
                    const errorMsg = result.error || result.message || JSON.stringify(result);
                    showAlert('moltbook', 'error', `‚ùå Post failed (${response.status}): ${errorMsg}`);
                    console.error('‚ùå Post error details:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: result,
                        sentData: postData
                    });

                    // TODO: Refund credit if post failed? (implement refund endpoint if needed)
                }
            } catch (error) {
                console.error('‚ùå Post error:', error);
                showAlert('moltbook', 'error', `‚ùå Failed to post: ${error.message}`);
            }
        }

        async function refreshProfile() {
            const moltbookData = JSON.parse(localStorage.getItem('openclaw_moltbook') || '{}');

            if (!moltbookData.api_key) {
                showAlert('moltbook', 'error', '‚ùå No agent connected');
                return;
            }

            console.log('üîÑ Refreshing profile...');
            showAlert('moltbook', 'success', 'üîÑ Refreshing...');

            try {
                // Call Moltbook API directly from browser
                const response = await fetch('https://www.moltbook.com/api/v1/agents/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${moltbookData.api_key}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Refresh response:', response.status);
                const result = await response.json();

                if (response.ok) {
                    const agentData = result.agent || result;

                    // Update stored data
                    const updatedData = {
                        ...moltbookData,
                        karma: agentData.karma || 0,
                        followers_count: agentData.follower_count || 0,
                        following_count: agentData.following_count || 0,
                        posts_count: (agentData.stats && agentData.stats.posts) || 0
                    };

                    localStorage.setItem('openclaw_moltbook', JSON.stringify(updatedData));
                    updateMoltbookProfile(updatedData);

                    showAlert('moltbook', 'success', `‚úÖ Refreshed! Karma: ${updatedData.karma} | Posts: ${updatedData.posts_count}`);
                    console.log('‚úÖ Profile refreshed');
                } else {
                    showAlert('moltbook', 'error', '‚ùå Refresh failed');
                }
            } catch (error) {
                console.error('‚ùå Refresh error:', error);
                showAlert('moltbook', 'error', `‚ùå Failed to refresh: ${error.message}`);
            }
        }

        function copyClaimUrl() {
            const claimUrl = document.getElementById('mb-claim-url').value;
            navigator.clipboard.writeText(claimUrl).then(() => {
                showAlert('moltbook', 'success', 'Claim URL copied to clipboard!');
            });
        }

        function openClaimUrl() {
            const claimUrl = document.getElementById('mb-claim-url').value;
            if (claimUrl) {
                window.open(claimUrl, '_blank');
            }
        }

        function openMoltbookProfile() {
            const moltbookData = JSON.parse(localStorage.getItem('openclaw_moltbook') || '{}');
            if (moltbookData.agent_name) {
                window.open(`https://www.moltbook.com/u/${moltbookData.agent_name}`, '_blank');
            }
        }

        // Load Moltbook state on tab switch
        function loadMoltbookState() {
            const moltbookData = JSON.parse(localStorage.getItem('openclaw_moltbook') || '{}');

            if (moltbookData.agent_id) {
                // Agent is registered - show profile if claimed
                if (moltbookData.is_claimed || moltbookData.api_key) {
                    // Show profile section
                    document.getElementById('registration-section').style.display = 'none';
                    document.getElementById('claim-section').style.display = 'none';
                    document.getElementById('profile-section').style.display = 'block';
                    updateMoltbookProfile(moltbookData);
                } else if (moltbookData.claim_url) {
                    // Show claim section
                    document.getElementById('registration-section').style.display = 'none';
                    document.getElementById('claim-section').style.display = 'block';

                    // Safely set values with null checks
                    const claimUrl = document.getElementById('mb-claim-url');
                    const verificationCode = document.getElementById('mb-verification-code');
                    if (claimUrl) claimUrl.value = moltbookData.claim_url || '';
                    if (verificationCode) verificationCode.value = moltbookData.verification_code || '';
                }
            }
        }

        // Auto-add loading states to all async button clicks
        document.addEventListener('DOMContentLoaded', () => {
            // Add click feedback to all buttons
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    // Visual click feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Override onclick handlers to add loading states
            const originalImport = window.importExistingAgent;
            window.importExistingAgent = async function() {
                const btn = document.querySelector('#import-agent-form .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Connecting...');
                try {
                    await originalImport();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalRegister = window.registerMoltbookAgent;
            window.registerMoltbookAgent = async function() {
                const btn = document.querySelector('#new-agent-form .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Registering...');
                try {
                    await originalRegister();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalTestConnection = window.testConnection;
            window.testConnection = async function() {
                const btn = document.getElementById('test-btn');
                if (btn) setButtonLoading(btn, true, 'Testing...');
                try {
                    await originalTestConnection();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalSaveLLM = window.saveLLMConfig;
            window.saveLLMConfig = async function() {
                const btn = event?.target || document.querySelector('#llm .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Saving...');
                try {
                    await originalSaveLLM();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalSaveIdentity = window.saveIdentity;
            window.saveIdentity = async function() {
                const btn = event?.target || document.querySelector('#identity .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Saving...');
                try {
                    await originalSaveIdentity();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalSaveUser = window.saveUser;
            window.saveUser = async function() {
                const btn = event?.target || document.querySelector('#user .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Saving...');
                try {
                    await originalSaveUser();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalSaveSoul = window.saveSoul;
            window.saveSoul = async function() {
                const btn = event?.target || document.querySelector('#soul .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Saving...');
                try {
                    await originalSaveSoul();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            const originalSaveSecurity = window.saveSecurity;
            window.saveSecurity = async function() {
                const btn = event?.target || document.querySelector('#security .btn-primary');
                if (btn) setButtonLoading(btn, true, 'Saving...');
                try {
                    await originalSaveSecurity();
                } finally {
                    if (btn) setButtonLoading(btn, false);
                }
            };

            console.log('‚úÖ Green Monkey Dashboard loaded with button feedback system');
        });

        // Initialize on load
        loadCurrentConfig();
    </script>

    <!-- Login/Signup Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close" onclick="closeModal('login-modal')">&times;</span>
            <h2 style="margin-bottom: 8px;">ü¶û Welcome to Green Monkey</h2>
            <p style="color: #666; margin-bottom: 24px;">Enter your email to sign in or create an account</p>

            <div id="login-form">
                <div class="form-group">
                    <label for="auth-email">Email Address</label>
                    <input type="email" id="auth-email" placeholder="you@example.com" />
                </div>

                <div class="info-box" style="font-size: 14px; padding: 12px; margin-bottom: 16px;">
                    ‚ú® New users get <strong>5 free post credits</strong>!
                </div>

                <button class="btn btn-primary" onclick="requestMagicLink()" style="width: 100%;">
                    Send Magic Link
                </button>

                <p style="font-size: 13px; color: #666; margin-top: 16px; text-align: center;">
                    We'll send a magic link to your email. No password needed!
                </p>
            </div>

            <div id="login-success" style="display: none; text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üìß</div>
                <h3>Check your email!</h3>
                <p style="color: #666; margin-top: 8px;">We've sent a magic link to your email. Click it to sign in.</p>
                <div id="magic-link-dev" style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px; display: none;">
                    <strong>Development Mode:</strong><br>
                    <a id="dev-magic-link" href="#" target="_blank" style="word-break: break-all;"></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Credits Modal -->
    <div id="buy-credits-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closeModal('buy-credits-modal')">&times;</span>
            <h2 style="margin-bottom: 8px;">üí≥ Buy Post Credits</h2>
            <p style="color: #666; margin-bottom: 24px;">Each credit lets you make one post to Moltbook</p>

            <div id="credit-packages" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;">
                <!-- Packages loaded dynamically -->
            </div>

            <div style="margin-top: 24px; padding: 16px; background: #f3f4f6; border-radius: 8px; font-size: 14px;">
                <strong>üí° How it works:</strong>
                <ul style="margin: 8px 0 0 20px; color: #666;">
                    <li>Select a package above</li>
                    <li>Complete payment via Stripe</li>
                    <li>Credits added instantly to your account</li>
                    <li>Each post to Moltbook uses 1 credit</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Payment Processing Overlay -->
    <div id="payment-processing" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 16px; text-align: center;">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <h3>Processing payment...</h3>
            <p style="color: #666; margin-top: 8px;">Please wait</p>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            position: relative;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: 300;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .btn-glass {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .btn-glass:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .credit-package {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .credit-package:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(99,102,241,0.2);
        }

        .credit-package.popular {
            border-color: var(--primary);
            background: rgba(99,102,241,0.05);
        }

        .credit-package.popular::before {
            content: "‚≠ê Popular";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>

    <script>
        // ==================== AUTH & CREDITS SYSTEM ====================

        let currentUser = null;
        let creditPackages = [];

        // Check authentication status
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        currentUser = data.user;
                        updateAuthUI(true);
                        console.log('‚úÖ User logged in:', currentUser.email);
                    } else {
                        updateAuthUI(false);
                    }
                } else {
                    updateAuthUI(false);
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                updateAuthUI(false);
            }
        }

        // Update UI based on auth status
        function updateAuthUI(isLoggedIn) {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');

            if (isLoggedIn && currentUser) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('credit-balance').textContent = currentUser.credit_balance;

                // Update subscription display
                updateSubscriptionDisplay(currentUser);
            } else {
                loginBtn.style.display = 'inline-block';
                userInfo.style.display = 'none';
            }
        }

        // Show/hide modals
        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'block';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('login-success').style.display = 'none';
        }

        async function showBuyCreditsModal() {
            document.getElementById('buy-credits-modal').style.display = 'block';
            await loadCreditPackages();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Request magic link
        async function requestMagicLink() {
            const email = document.getElementById('auth-email').value.trim();

            if (!email) {
                alert('Please enter your email address');
                return;
            }

            try {
                const response = await fetch('/api/auth/request-magic-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('login-success').style.display = 'block';

                    // Show dev link if available
                    if (data.dev_link) {
                        document.getElementById('magic-link-dev').style.display = 'block';
                        const linkEl = document.getElementById('dev-magic-link');
                        linkEl.href = data.dev_link;
                        linkEl.textContent = data.dev_link;
                    }

                    console.log('‚úÖ Magic link sent to:', email);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send magic link'));
                }
            } catch (error) {
                console.error('Error requesting magic link:', error);
                alert('Failed to send magic link. Please try again.');
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                currentUser = null;
                updateAuthUI(false);
                console.log('‚úÖ Logged out');
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Load credit packages
        async function loadCreditPackages() {
            try {
                const response = await fetch('/api/credits/packages');
                const data = await response.json();

                creditPackages = data.packages;
                renderCreditPackages();
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        // Render credit packages
        function renderCreditPackages() {
            const container = document.getElementById('credit-packages');
            container.innerHTML = '';

            creditPackages.forEach((pkg, index) => {
                const isPopular = index === 1; // Middle package is popular
                const packageEl = document.createElement('div');
                packageEl.className = 'credit-package' + (isPopular ? ' popular' : '');
                packageEl.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 8px;">üì¶</div>
                    <div style="font-weight: 700; font-size: 20px; margin-bottom: 4px;">${pkg.credits} Credits</div>
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 4px;">$${pkg.price.toFixed(2)}</div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 12px;">$${pkg.price_per_credit.toFixed(3)} per post</div>
                    <button class="btn btn-primary" style="width: 100%; padding: 10px;" onclick="purchaseCredits(${pkg.id})">
                        Buy Now
                    </button>
                `;
                container.appendChild(packageEl);
            });
        }

        // Purchase credits
        async function purchaseCredits(packageId) {
            if (!currentUser) {
                closeModal('buy-credits-modal');
                showLoginModal();
                alert('Please log in first to purchase credits');
                return;
            }

            try {
                document.getElementById('payment-processing').style.display = 'flex';

                const response = await fetch('/api/credits/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ package_id: packageId })
                });

                const data = await response.json();

                if (response.ok && data.checkout_url) {
                    // Redirect to Stripe Checkout
                    window.location.href = data.checkout_url;
                } else {
                    document.getElementById('payment-processing').style.display = 'none';
                    alert('Error: ' + (data.error || 'Failed to create checkout'));
                }
            } catch (error) {
                document.getElementById('payment-processing').style.display = 'none';
                console.error('Error purchasing credits:', error);
                alert('Failed to start checkout. Please try again.');
            }
        }

        // ==================== SUBSCRIPTION FUNCTIONS ====================

        let subscriptionPlans = [];
        let currentSubscription = null;

        async function loadSubscriptionPlans() {
            try {
                const response = await fetch('/api/subscriptions/plans', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (response.ok) {
                    subscriptionPlans = data.plans;
                    renderSubscriptionPlans();
                }
            } catch (error) {
                console.error('Error loading subscription plans:', error);
            }
        }

        function renderSubscriptionPlans() {
            const container = document.getElementById('subscription-plans');
            if (!container || subscriptionPlans.length === 0) return;

            const tierColors = {
                'free': 'rgba(107,114,128,0.2)',
                'starter': 'rgba(59,130,246,0.2)',
                'pro': 'rgba(139,92,246,0.2)',
                'team': 'rgba(236,72,153,0.2)'
            };

            const tierEmojis = {
                'free': 'üÜì',
                'starter': 'üöÄ',
                'pro': '‚≠ê',
                'team': 'üë•'
            };

            container.innerHTML = subscriptionPlans.map(plan => {
                const isCurrentTier = currentSubscription && currentSubscription.tier === plan.tier;
                const isFreeUser = !currentSubscription || currentSubscription.tier === 'free';
                const canUpgrade = isFreeUser || (currentSubscription && getTierLevel(plan.tier) > getTierLevel(currentSubscription.tier));

                return `
                    <div style="background: ${tierColors[plan.tier] || 'rgba(255,255,255,0.1)'}; border: 2px solid ${isCurrentTier ? 'rgba(16,185,129,0.5)' : 'rgba(255,255,255,0.2)'}; border-radius: 12px; padding: 24px; position: relative;">
                        ${isCurrentTier ? '<div style="position: absolute; top: 12px; right: 12px; background: rgba(16,185,129,0.3); padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">CURRENT</div>' : ''}

                        <div style="font-size: 32px; margin-bottom: 8px;">${tierEmojis[plan.tier]}</div>
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">${plan.name}</div>
                        <div style="font-size: 36px; font-weight: 700; margin-bottom: 16px;">
                            $${plan.price}
                            <span style="font-size: 16px; opacity: 0.7;">/month</span>
                        </div>

                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 16px; margin-bottom: 16px;">
                            <div style="font-size: 14px; line-height: 1.8;">
                                ${plan.features.unlimited_posts ? '<div style="margin-bottom: 8px;">‚úÖ <strong>Unlimited Posts</strong> (no rate limit!)</div>' : '<div style="margin-bottom: 8px;">‚è±Ô∏è 30-minute post cooldown</div>'}
                                <div style="margin-bottom: 8px;">ü§ñ Up to ${plan.features.max_agents === 999 ? 'Unlimited' : plan.features.max_agents} agent${plan.features.max_agents !== 1 ? 's' : ''}</div>
                                ${plan.features.scheduled_posting ? '<div style="margin-bottom: 8px;">üìÖ Scheduled posting</div>' : ''}
                                ${plan.features.analytics ? '<div style="margin-bottom: 8px;">üìä Analytics dashboard</div>' : ''}
                                ${plan.features.api_access ? '<div style="margin-bottom: 8px;">üîå API access</div>' : ''}
                                ${plan.features.team_members > 1 ? `<div style="margin-bottom: 8px;">üë• ${plan.features.team_members} team members</div>` : ''}
                                ${plan.features.priority_support ? '<div style="margin-bottom: 8px;">‚ö° Priority support</div>' : ''}
                            </div>
                        </div>

                        ${!isCurrentTier && canUpgrade ? `
                            <button class="btn btn-primary" onclick="subscribeToPlan(${plan.id})" style="width: 100%; padding: 12px; font-weight: 600;">
                                ${isFreeUser ? 'Get Started' : 'Upgrade'}
                            </button>
                        ` : isCurrentTier ? `
                            <button class="btn btn-secondary" onclick="manageSubscription()" style="width: 100%; padding: 12px;">
                                Manage Subscription
                            </button>
                        ` : `
                            <button class="btn btn-secondary" disabled style="width: 100%; padding: 12px; opacity: 0.5;">
                                Contact Sales
                            </button>
                        `}
                    </div>
                `;
            }).join('');
        }

        function getTierLevel(tier) {
            const levels = { 'free': 0, 'starter': 1, 'pro': 2, 'team': 3 };
            return levels[tier] || 0;
        }

        async function subscribeToPlan(planId) {
            if (!currentUser) {
                showLoginModal();
                alert('Please log in first to subscribe');
                return;
            }

            try {
                const response = await fetch('/api/subscriptions/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ plan_id: planId })
                });

                const data = await response.json();

                if (response.ok && data.checkout_url) {
                    // Redirect to Stripe Checkout
                    window.location.href = data.checkout_url;
                } else {
                    alert('Error: ' + (data.error || 'Failed to create checkout'));
                }
            } catch (error) {
                console.error('Error subscribing to plan:', error);
                alert('Failed to start checkout. Please try again.');
            }
        }

        async function manageSubscription() {
            if (!currentUser) {
                showLoginModal();
                return;
            }

            try {
                const response = await fetch('/api/subscriptions/portal', {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok && data.portal_url) {
                    // Redirect to Stripe Customer Portal
                    window.location.href = data.portal_url;
                } else {
                    alert('Error: ' + (data.error || 'Failed to open portal'));
                }
            } catch (error) {
                console.error('Error opening customer portal:', error);
                alert('Failed to open subscription management. Please try again.');
            }
        }

        function showSubscriptionTab() {
            // Switch to subscription tab
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            const subTab = document.querySelector('.tab[data-tab="subscription"]');
            const subContent = document.getElementById('subscription');

            if (subTab) subTab.classList.add('active');
            if (subContent) subContent.classList.add('active');

            // Load plans if not loaded
            if (subscriptionPlans.length === 0) {
                loadSubscriptionPlans();
            }
        }

        function updateSubscriptionDisplay(userData) {
            // Update badge in header
            const badge = document.getElementById('subscription-tier-badge');
            const tierEmojis = {
                'free': 'üÜì Free',
                'starter': 'üöÄ Starter',
                'pro': '‚≠ê Pro',
                'team': 'üë• Team'
            };

            if (badge) {
                badge.textContent = tierEmojis[userData.subscription_tier || 'free'];
            }

            // Update current subscription card
            const tierName = document.getElementById('current-tier-name');
            const details = document.getElementById('subscription-details');
            const manageBtn = document.getElementById('manage-subscription-btn');

            if (tierName) {
                const planNames = {
                    'free': 'Free Tier',
                    'starter': 'Starter Plan',
                    'pro': 'Pro Plan',
                    'team': 'Team Plan'
                };
                tierName.textContent = planNames[userData.subscription_tier || 'free'];
            }

            if (details) {
                if (userData.subscription_status === 'active' && userData.subscription_tier !== 'free') {
                    const expiresAt = new Date(userData.subscription_expires_at).toLocaleDateString();
                    details.textContent = `Active ‚Ä¢ Renews on ${expiresAt}`;
                    if (manageBtn) manageBtn.style.display = 'block';
                } else if (userData.subscription_status === 'past_due') {
                    details.textContent = '‚ö†Ô∏è Payment failed ‚Ä¢ Please update payment method';
                    if (manageBtn) manageBtn.style.display = 'block';
                } else {
                    details.textContent = '30-minute post cooldown ‚Ä¢ Upgrade for unlimited posts!';
                    if (manageBtn) manageBtn.style.display = 'none';
                }
            }

            currentSubscription = {
                tier: userData.subscription_tier || 'free',
                status: userData.subscription_status
            };

            // Re-render plans if already loaded
            if (subscriptionPlans.length > 0) {
                renderSubscriptionPlans();
            }
        }

        // Check auth status and handle payment redirects on load
        window.addEventListener('load', () => {
            // Always check authentication status
            checkAuthStatus();

            // Load subscription plans
            loadSubscriptionPlans();

            // Check for payment/subscription status in URL (after Stripe redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const subscriptionStatus = urlParams.get('subscription');

            if (paymentStatus === 'success') {
                alert('üéâ Payment successful! Your credits have been added.');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (paymentStatus === 'cancelled') {
                alert('Payment was cancelled');
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (subscriptionStatus === 'success') {
                alert('üéâ Subscription activated! Welcome to your new plan!');
                showSubscriptionTab();
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Reload user data to get updated subscription
                setTimeout(() => checkAuthStatus(), 1000);
            } else if (subscriptionStatus === 'cancelled') {
                alert('Subscription setup was cancelled');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>
